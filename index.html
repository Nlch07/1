<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Мой Чат</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#000;color:#fff;font-family:system-ui,sans-serif;height:100vh;display:flex;flex-direction:column}
    .screen{display:none;flex-direction:column;height:100%}
    .active{display:flex!important}
    #menu{justify-content:center;align-items:center;gap:30px;padding:20px}
    .btn{width:90%;max-width:400px;padding:24px;font-size:21px;font-weight:bold;border-radius:20px;border:none;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    #btn-name{background:#ff2d55}
    #btn-public{background:#00d4ff}
    #btn-create{background:#7c4dff}
    header{padding:16px;background:#111;text-align:center;font-size:19px;position:relative}
    .back{position:absolute;top:10px;left:10px;background:none;border:none;color:#fff;font-size:30px;cursor:pointer}
    #messages,#messages-private{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:12px}
    .msg{max-width:80%;padding:12px 16px;border-radius:20px;line-height:1.4;word-wrap:break-word}
    .my{align-self:flex-end;background:#0d8bff;border-bottom-right-radius:4px}
    .other{align-self:flex-start;background:#333;border-bottom-left-radius:4px}
    .name{font-size:13px;opacity:0.8;margin-bottom:4px}
    #input-area{padding:12px;background:#111;display:flex;gap:12px}
    #message,#msg-private{flex:1;padding:16px 20px;background:#222;color:#fff;border:none;border-radius:30px;font-size:17px}
    #send,#send-private{width:56px;height:56px;background:#0d8bff;border:none;border-radius:50%;font-size:26px;cursor:pointer}
    .link-box{background:#222;padding:20px;margin:20px;border-radius:16px;text-align:center}
    .link-box div{color:#7c4dff;font-size:18px;font-weight:bold;word-break:break-all}
    .copy-btn{background:#7c4dff;padding:14px 24px;border:none;border-radius:12px;margin-top:15px;font-size:16px;cursor:pointer}
  </style>
</head>
<body>

  <!-- Меню -->
  <div id="menu" class="screen active">
    <h1 style="font-size:30px;margin-bottom:50px">Мой Чат</h1>
    <button id="btn-name" class="btn">Указать имя</button>
    <button id="btn-public" class="btn">Общий чат</button>
    <button id="btn-create" class="btn">Создать личный чат</button>
  </div>

  <!-- Установка имени -->
  <div id="setname" class="screen">
    <h2 style="padding:30px 20px;text-align:center">Как тебя зовут?</h2>
    <div style="padding:20px">
      <input type="text" id="nameInput" placeholder="Твоё имя" maxlength="20" style="width:100%;padding:18px;font-size:18px;border-radius:16px;background:#222;border:none;color:white;text-align:center">
      <button onclick="saveName()" style="margin-top:20px;width:100%;padding:18px;background:#ff2d55;border:none;border-radius:16px;color:white;font-size:18px">Сохранить</button>
    </div>
  </div>

  <!-- Экран с ссылкой после создания чата -->
  <div id="create" class="screen">
    <header>Личный чат готов! <button class="back" onclick="goMenu()">←</button></header>
    <div style="flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:20px">
      <p style="text-align:center;margin-bottom:20px">Отправь эту ссылку человеку:</p>
      <div class="link-box">
        <div id="generated-link"></div>
        <button class="copy-btn" onclick="copyLink()">Скопировать ссылку</button>
      </div>
      <button onclick="enterGeneratedChat()" style="margin-top:40px;padding:16px 32px;background:#7c4dff;border:none;border-radius:16px;font-size:18px">
        Войти в чат
      </button>
    </div>
  </div>

  <!-- Общий чат -->
  <div id="public" class="screen">
    <header>Общий чат <button class="back" onclick="goMenu()">←</button></header>
    <div id="messages"></div>
    <div id="input-area">
      <input type="text" id="message" placeholder="Сообщение..." maxlength="500" autocomplete="off">
      <button id="send">➤</button>
    </div>
  </div>

  <!-- Личный чат -->
  <div id="private" class="screen">
    <header>Личный чат <button class="back" onclick="goMenu()">←</button></header>
    <div id="messages-private"></div>
    <div id="input-area">
      <input type="text" id="msg-private" placeholder="Сообщение..." maxlength="500" autocomplete="off">
      <button id="send-private">➤</button>
    </div>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCysKcXFVoqWDIQzkdObB-9sgm54cRGyp0",
  authDomain: "test3-88cee.firebaseapp.com",
  databaseURL: "https://test3-88cee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test3-88cee",
  storageBucket: "test3-88cee.firebasestorage.app",
  messagingSenderId: "469479851370",
  appId: "1:469479851370:web:915e95767b012c281e1113"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let myName = localStorage.getItem('myName') || 'Аноним';
let currentCode = '';

// Имя
document.getElementById('btn-name').onclick = () => { showScreen('setname'); document.getElementById('nameInput').value = myName; };
function saveName() {
  myName = document.getElementById('nameInput').value.trim() || 'Аноним';
  localStorage.setItem('myName', myName);
  goMenu();
}

// Общий чат
document.getElementById('btn-public').onclick = () => { showScreen('public'); startChat('public_messages', 'messages', 'message', 'send'); };

// Создать личный чат
document.getElementById('btn-create').onclick = () => {
  const words = ['love','secret','cat','sun','moon','star','heart','fire','ice','dream','kiss','hug','baby','angel','devil','magic','night','rose','sky','ocean'];
  const w1 = words[Math.floor(Math.random()*words.length)];
  const w2 = words[Math.floor(Math.random()*words.length)];
  const num = Math.floor(Math.random()*100);
  currentCode = w1 + w2 + num;

  const link = location.href.split('?')[0] + '?c=' + currentCode;
  document.getElementById('generated-link').textContent = link;
  showScreen('create');
};

function copyLink() {
  navigator.clipboard.writeText(document.getElementById('generated-link').textContent);
  alert('Ссылка скопирована в буфер!');
}

function enterGeneratedChat() {
  openPrivateChat(currentCode);
}

// Если в ссылке есть ?c=...
const params = new URLSearchParams(location.search);
const codeFromUrl = params.get('c');
if (codeFromUrl) {
  currentCode = codeFromUrl;
  openPrivateChat(codeFromUrl);
}

function openPrivateChat(code) {
  showScreen('private');
  startChat('private_chats/' + code + '/messages', 'messages-private', 'msg-private', 'send-private');
}

// Универсальная функция для любого чата
let currentListener = null;
function startChat(path, containerId, inputId, sendBtnId) {
  const container = document.getElementById(containerId);
  container.innerHTML = ''; // очищаем

  const ref = db.ref(path);

  // Убираем старый слушатель, если был
  if (currentListener) currentListener();
  
  currentListener = ref.orderByChild('time').limitToLast(100).on('child_added', snap => {
    const msg = snap.val();
    const div = document.createElement('div');
    div.className = 'msg ' + (msg.name === myName ? 'my' : 'other');
    div.innerHTML = `<div class="name">${msg.name === myName ? 'Вы' : msg.name}</div><div>${msg.text}</div>`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  });

  // Отправка
  const sendHandler = () => {
    const text = document.getElementById(inputId).value.trim();
    if (text) {
      ref.push({name: myName, text: text, time: Date.now()});
      document.getElementById(inputId).value = '';
    }
  };
  document.getElementById(sendBtnId).onclick = sendHandler;
  document.getElementById(inputId).onkeypress = e => { if (e.key === 'Enter') sendHandler(); };
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function goMenu() {
  if (currentListener) currentListener();
  currentListener = null;
  showScreen('menu');
  history.replaceState(null, null, location.pathname);
}
</script>
</body>
</html>
