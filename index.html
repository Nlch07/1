<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AstikMessenger</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --bg:#eef3f9;
    --card:#fff;
    --accent1: #3a7bd5;
    --accent2: #00d2ff;
    --mebubble: #d9f7ff;
    --text:#222;
    --muted:#6b7280;
  }
  [data-theme="dark"]{
    --bg:#0b1220; --card:#0f1724; --mebubble:#0b394f; --text:#e6eef7; --muted:#95a3b8;
  }

  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg),#f6fbff);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
  .app{width:100%;max-width:980px;height:100vh;background:transparent;display:grid;grid-template-columns:340px 1fr;border-radius:12px;overflow:hidden;box-shadow:0 20px 50px rgba(15,23,42,0.2)}
  /* left column (contacts/settings) */
  .sidebar{background:var(--card);padding:12px;display:flex;flex-direction:column;gap:12px;border-right:1px solid rgba(0,0,0,0.04)}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  .brand h1{font-size:18px;margin:0}
  .user-row{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px}
  .avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:600}
  .presence{width:10px;height:10px;border-radius:50%;border:2px solid var(--card);box-shadow:0 0 0 rgba(0,0,0,0.1) inset;position:relative;left:-10px;top:24px}
  .controls{display:flex;gap:8px;margin-left:auto}
  .btn{background:none;border:none;padding:8px;border-radius:8px;cursor:pointer}
  .search{padding:8px;border-radius:10px;border:1px solid #e6eef7}
  .contacts{overflow:auto;flex:1}
  .contact{display:flex;gap:8px;padding:8px;border-radius:10px;cursor:pointer;align-items:center}
  .contact:hover{background:linear-gradient(90deg,rgba(58,123,213,0.06),rgba(0,210,255,0.03))}
  .contact .meta{flex:1}
  .small{font-size:12px;color:var(--muted)}
  /* right column (chat) */
  .chat{display:flex;flex-direction:column;background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent)}
  .chat-header{display:flex;align-items:center;padding:12px 18px;border-bottom:1px solid rgba(0,0,0,0.04);gap:12px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white}
  .chat-body{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:12px;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.02))}
  .message-row{display:flex;gap:8px;max-width:75%}
  .msg {padding:10px 12px;border-radius:12px;background:var(--card);box-shadow:0 6px 15px rgba(15,23,42,0.04);position:relative}
  .me {margin-left:auto;background:var(--mebubble)}
  .nick{font-size:12px;font-weight:700;margin-bottom:6px}
  .time{font-size:11px;color:var(--muted);margin-top:6px;text-align:right}
  .meta-right{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
  .compose{display:flex;padding:12px;gap:8px;border-top:1px solid rgba(0,0,0,0.04);background:var(--card)}
  .compose input[type="text"]{flex:1;padding:10px;border-radius:999px;border:1px solid #e6eef7}
  .compose button{padding:10px 12px;border-radius:999px;border:none;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;cursor:pointer}
  .small-muted{font-size:12px;color:var(--muted)}
  .settings-panel{padding:12px;background:var(--card);border-radius:10px}
  .image-thumb{max-width:220px;border-radius:8px;margin-top:8px;display:block}
  .msg-actions{position:absolute;top:6px;right:8px;display:flex;gap:6px}
  .pill{padding:4px 8px;border-radius:999px;background:rgba(0,0,0,0.03);font-size:12px}
  /* responsive */
  @media(max-width:880px){
    .app{grid-template-columns:1fr;max-width:640px}
    .sidebar{display:none}
  }
</style>
</head>
<body>

<div class="app" id="app" data-theme="light" style="max-width:1000px;">
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo">A</div>
      <div>
        <h1 style="margin:0">AstikMessenger</h1>
        <div class="small">–ë—ã—Å—Ç—Ä—ã–π —á–∞—Ç –Ω–∞ Firebase</div>
      </div>
      <div style="margin-left:auto" id="authBtns">
        <button class="btn" id="btnSignIn">–í–æ–π—Ç–∏</button>
      </div>
    </div>

    <div id="userInfo" style="display:none;align-items:center;">
      <div class="user-row" style="gap:12px">
        <div id="myAvatar" class="avatar" style="background:linear-gradient(135deg,var(--accent1),var(--accent2));">U</div>
        <div>
          <div id="myName" style="font-weight:700">User</div>
          <div id="myMail" class="small-muted small">‚Äî</div>
        </div>
        <div class="controls" style="margin-left:auto">
          <button class="btn" id="btnSignOut" title="–í—ã–π—Ç–∏">‚§´</button>
          <button class="btn" id="btnTheme" title="–¢–µ–º–∞">üåì</button>
        </div>
      </div>
    </div>

    <div class="settings-panel">
      <div style="display:flex;gap:8px">
        <input id="search" class="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." />
        <button class="btn" id="btnNewChat" title="–ù–æ–≤—ã–π —á–∞—Ç">Ôºã</button>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <input id="avatarColor" type="color" value="#3a7bd5" title="–¶–≤–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞">
        <label class="small-muted" style="align-self:center">–¶–≤–µ—Ç –∞–≤–∞—Ç–∞—Ä–∞</label>
      </div>
    </div>

    <div class="contacts" id="contactsList">
      <!-- contacts list -->
    </div>

    <div style="padding:8px;">
      <div class="small-muted">AstikMessenger ‚Äî –¥–µ–º–æ</div>
    </div>
  </div>

  <!-- CHAT -->
  <div class="chat" id="chatPanel" style="display:flex;flex-direction:column;">
    <div class="chat-header">
      <div style="display:flex;align-items:center;gap:12px">
        <div id="chatAvatar" class="avatar" style="background:linear-gradient(135deg,var(--accent1),var(--accent2));">G</div>
        <div>
          <div id="chatTitle">–û–±—â–∏–π —á–∞—Ç</div>
          <div id="chatSub" class="small-muted">–û–Ω–ª–∞–π–Ω: <span id="onlineCount">0</span></div>
        </div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="btnClear" class="btn" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">üóëÔ∏è</button>
        <button id="btnSettings" class="btn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
      </div>
    </div>

    <div class="chat-body" id="messages">
      <!-- messages appended here -->
    </div>

    <div class="compose">
      <input type="file" id="fileInput" accept="image/*" style="display:none" />
      <button id="btnUpload" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" class="btn">üì∑</button>
      <input id="inputMessage" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
      <button id="btnSend">‚û§</button>
    </div>
  </div>
</div>

<!-- Toast / notifications -->
<audio id="notifySound" src="" preload="auto"></audio>

<script type="module">
/* ===========================
   Firebase + App logic
   =========================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getAuth, GoogleAuthProvider, signInWithPopup, signOut,
  onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import {
  getDatabase, ref, push, onChildAdded, onChildChanged, onValue, set, update, remove, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
import {
  getStorage, ref as sref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

/* ---------- YOUR FIREBASE CONFIG - preserved from you ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCysKcXFVoqWDIQzkdObB-9sgm54cRGyp0",
  authDomain: "test3-88cee.firebaseapp.com",
  databaseURL: "https://test3-88cee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test3-88cee",
  storageBucket: "test3-88cee.firebasestorage.app",
  messagingSenderId: "469479851370",
  appId: "1:469479851370:web:915e95767b012c281e1113"
};
/* ------------------------------------------------------------- */

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const storage = getStorage(app);

/* Realtime DB paths */
const MESSAGES = "messages";       // messages/{msgId}
const PRESENCE = "presence";       // presence/{uid}
const TYPING = "typing";           // typing/{uid} = name or ""
const USERS = "users";             // users/{uid} metadata

/* app elements */
const btnSignIn = document.getElementById("btnSignIn");
const btnSignOut = document.getElementById("btnSignOut");
const btnTheme = document.getElementById("btnTheme");
const myAvatar = document.getElementById("myAvatar");
const myNameEl = document.getElementById("myName");
const myMailEl = document.getElementById("myMail");
const userInfoEl = document.getElementById("userInfo");
const authBtnsEl = document.getElementById("authBtns");
const inputMessage = document.getElementById("inputMessage");
const btnSend = document.getElementById("btnSend");
const messagesEl = document.getElementById("messages");
const btnUpload = document.getElementById("btnUpload");
const fileInput = document.getElementById("fileInput");
const btnClear = document.getElementById("btnClear");
const inputSearch = document.getElementById("search");
const contactsList = document.getElementById("contactsList");
const appRoot = document.getElementById("app");
const avatarColorInput = document.getElementById("avatarColor");
const notifySound = document.getElementById("notifySound");
notifySound.src = ""; // set if you host a sound file

let currentUser = null;
let currentChatId = "global"; // simple single-room demo
let localDeviceId = "dev_" + Math.random().toString(36).slice(2,9);

/* theme */
let theme = localStorage.getItem("astik:theme") || "light";
appRoot.setAttribute("data-theme", theme);

/* helper util */
function uid(){ return currentUser ? currentUser.uid : localDeviceId; }
function fmtTime(ts){
  const d = new Date(ts || Date.now());
  return d.getHours().toString().padStart(2,"0") + ":" + d.getMinutes().toString().padStart(2,"0");
}

/* ---------- AUTH ---------- */
btnSignIn.addEventListener("click", async () => {
  // quick popup with Google; if user prefers email, we could show a modal (omitted to keep file single)
  const provider = new GoogleAuthProvider();
  try {
    await signInWithPopup(auth, provider);
  } catch (e) {
    alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + e.message);
  }
});

btnSignOut.addEventListener("click", async () => {
  await signOut(auth);
});

/* On auth state change */
onAuthStateChanged(auth, async user => {
  currentUser = user;
  if (user) {
    // save user metadata to DB
    const userRef = ref(db, `${USERS}/${user.uid}`);
    set(userRef, {
      name: user.displayName || user.email || "User",
      email: user.email || "",
      avatarColor: avatarColorInput.value || "#3a7bd5",
      lastSeen: Date.now(),
    });

    authBtnsEl.style.display = "none";
    userInfoEl.style.display = "flex";
    myAvatar.style.background = `linear-gradient(135deg,var(--accent1),var(--accent2))`;
    myAvatar.textContent = user.displayName ? user.displayName[0].toUpperCase() : (user.email?user.email[0].toUpperCase() : "U");
    myNameEl.textContent = user.displayName || user.email || "User";
    myMailEl.textContent = user.email || "‚Äî";

    // presence - mark online
    const pRef = ref(db, `${PRESENCE}/${user.uid}`);
    set(pRef, { online: true, lastSeen: Date.now(), name: myNameEl.textContent, color: avatarColorInput.value });
    // when window unloads set offline
    window.addEventListener("unload", () => {
      set(ref(db, `${PRESENCE}/${user.uid}`), { online:false, lastSeen: Date.now(), name: myNameEl.textContent });
    });

    // subscribe counters / contacts / messages
    listenMessages();
    listenPresence();
    listenTyping();
  } else {
    // signed out
    authBtnsEl.style.display = "block";
    userInfoEl.style.display = "none";
    currentUser = null;
    messagesEl.innerHTML = "";
    contactsList.innerHTML = "";
  }
});

/* ---------- PRESENCE & TYPING ---------- */
function listenPresence(){
  const presRef = ref(db, PRESENCE);
  onValue(presRef, snapshot => {
    const val = snapshot.val() || {};
    const online = Object.values(val).filter(u => u && u.online).length;
    document.getElementById("onlineCount").textContent = online;
    // populate contacts with presence
    contactsList.innerHTML = "";
    Object.entries(val).forEach(([k,u]) => {
      if (!u) return;
      const c = document.createElement("div");
      c.className = "contact";
      c.innerHTML = `<div class="avatar" style="background:${u.color || '#3a7bd5'}">${(u.name||'U')[0].toUpperCase()}</div>
        <div class="meta">
          <div style="display:flex;align-items:center;gap:8px"><div style="font-weight:700">${u.name||'User'}</div><div class="small">${u.online?'<span style=\"color:lime\">‚óè</span> online':'offline'}</div></div>
          <div class="small-muted">–ø–æ—Å–ª–µ–¥–Ω–µ–µ: ${new Date(u.lastSeen || Date.now()).toLocaleString()}</div>
        </div>`;
      contactsList.appendChild(c);
    });
  });
}

/* typing */
inputMessage.addEventListener("input", () => {
  const tRef = ref(db, `${TYPING}/${currentChatId}/${uid()}`);
  set(tRef, inputMessage.value ? (currentUser?.displayName || myNameEl.textContent) + " –ø–µ—á–∞—Ç–∞–µ—Ç..." : "");
  // clear after 2s of inactivity
  clearTimeout(window._typingTimer);
  window._typingTimer = setTimeout(()=> set(tRef, ""), 1800);
});

function listenTyping(){
  const tRef = ref(db, `${TYPING}/${currentChatId}`);
  onValue(tRef, snap => {
    const val = snap.val() || {};
    const names = Object.values(val).filter(Boolean).slice(0,3);
    // show tiny toast in header
    const sub = document.getElementById("chatSub");
    if (names.length) sub.textContent = names.join(", ");
    else sub.textContent = `–û–Ω–ª–∞–π–Ω: ${document.getElementById("onlineCount").textContent}`;
  });
}

/* ---------- MESSAGES ---------- */
/* Structure:
   messages/{msgId} = {
     uid, name, text, time, type:'text'|'image', imageUrl, avatarColor
     delivered: {uid:true}, read: {uid:true}
   }
*/

function listenMessages(){
  const msgsRef = ref(db, MESSAGES);
  onChildAdded(msgsRef, snapshot => {
    const id = snapshot.key;
    const msg = snapshot.val();
    renderMessage(id, msg);
    // if it's not mine, mark delivered by me
    if (uid() && msg.uid !== uid()){
      const delRef = ref(db, `${MESSAGES}/${id}/delivered/${uid()}`);
      set(delRef, { at: Date.now() });
      // notify
      notifyUser(msg);
    } else {
      // if it's mine, it already exists locally - show sent status
      // nothing extra needed here for basic demo
    }
  });

  onChildChanged(ref(db, MESSAGES), snapshot => {
    // re-render changed message
    const id = snapshot.key;
    const msg = snapshot.val();
    const el = document.getElementById("msg_"+id);
    if (el) {
      // update content/time/status
      updateMessageElement(el, id, msg);
    }
  });
}

function renderMessage(id, msg){
  // avoid duplicate render if exists
  if (document.getElementById("msg_"+id)) return;
  const wrapper = document.createElement("div");
  wrapper.id = "msg_"+id;
  const isMe = msg.uid === uid();
  wrapper.style.display = "flex";
  wrapper.style.justifyContent = isMe ? "flex-end" : "flex-start";
  wrapper.className = "message-row";

  const bubble = document.createElement("div");
  bubble.className = "msg" + (isMe ? " me" : "");
  bubble.style.borderRadius = "12px";
  bubble.style.maxWidth = "75%";
  bubble.style.position = "relative";

  // avatar / nick for others
  if (!isMe){
    const nick = document.createElement("div");
    nick.className = "nick";
    nick.textContent = msg.name || 'User';
    bubble.appendChild(nick);
  }

  // message body
  if (msg.type === "image" && msg.imageUrl){
    const img = document.createElement("img");
    img.src = msg.imageUrl;
    img.className = "image-thumb";
    bubble.appendChild(img);
  }

  if (msg.text && (!msg.type || msg.type === "text")){
    const p = document.createElement("div");
    p.textContent = msg.text;
    bubble.appendChild(p);
  }
  // time + status
  const meta = document.createElement("div");
  meta.className = "time";
  meta.style.display = "flex";
  meta.style.justifyContent = "space-between";
  meta.style.alignItems = "center";
  meta.style.gap = "8px";
  const timeSpan = document.createElement("div");
  timeSpan.textContent = fmtTime(msg.time);
  const statusSpan = document.createElement("div");
  statusSpan.className = "meta-right";

  // compute ticks: if my message: check delivered/read
  if (isMe){
    const del = msg.delivered ? Object.keys(msg.delivered).length : 0;
    const read = msg.read ? Object.keys(msg.read).length : 0;
    // simple visual: 1 tick when delivered>0, 2 ticks when read>0
    if (read>0) statusSpan.innerHTML = '<span title="–ü—Ä–æ—á–∏—Ç–∞–Ω–æ">‚úì‚úì</span>';
    else if (del>0) statusSpan.innerHTML = '<span title="–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ">‚úì</span>';
    else statusSpan.innerHTML = '<span title="–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ">‚Ä¶</span>';
  } else {
    statusSpan.textContent = "";
  }

  meta.appendChild(timeSpan);
  meta.appendChild(statusSpan);
  bubble.appendChild(meta);

  // actions for own message (edit/delete)
  if (isMe){
    const actions = document.createElement("div");
    actions.className = "msg-actions";
    actions.innerHTML = `<button title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="btn">‚úé</button><button title="–£–¥–∞–ª–∏—Ç—å" class="btn">üóë</button>`;
    // edit
    actions.children[0].addEventListener("click", ()=>{
      const newText = prompt("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:", msg.text||"");
      if (newText !== null){
        update(ref(db, `${MESSAGES}/${id}`), { text: newText, edited: true, editedAt: Date.now() });
      }
    });
    // delete
    actions.children[1].addEventListener("click", async ()=>{
      if (confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")){
        // mark as deleted (so we don't remove history)
        update(ref(db, `${MESSAGES}/${id}`), { deleted: true, text: "–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ", deletedAt: Date.now() });
      }
    });
    bubble.appendChild(actions);
  }

  wrapper.appendChild(bubble);
  messagesEl.appendChild(wrapper);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* update message element on change */
function updateMessageElement(el, id, msg){
  // simple approach: remove and re-render
  const parent = el.parentNode;
  if (parent){
    parent.removeChild(el);
    renderMessage(id, msg);
  }
}

/* send text message */
btnSend.addEventListener("click", sendMessage);
inputMessage.addEventListener("keydown", (e)=>{ if (e.key === "Enter") sendMessage(); });

async function sendMessage(){
  const text = inputMessage.value.trim();
  if (!text && !filePending) return;
  const payload = {
    uid: uid(),
    name: currentUser ? (currentUser.displayName || currentUser.email) : "–ì–æ—Å—Ç—å",
    text: text || "",
    time: Date.now(),
    type: filePending ? "image" : "text",
    avatarColor: avatarColorInput.value || "#3a7bd5"
  };

  // if filePending is set (image uploaded and has url) attach imageUrl
  if (filePending){
    payload.imageUrl = filePending;
    filePending = null;
  }

  // push to DB
  await push(ref(db, MESSAGES), payload);
  inputMessage.value = "";
  // clear typing entry
  set(ref(db, `${TYPING}/${currentChatId}/${uid()}`), "");
}

/* ---------- IMAGE UPLOAD ---------- */
let filePending = null;
btnUpload.addEventListener("click", ()=> fileInput.click());
fileInput.addEventListener("change", async (e)=>{
  const f = e.target.files[0];
  if (!f) return;
  // preview + upload
  const path = `images/${uid()}/${Date.now()}_${f.name}`;
  const storageRef = sref(storage, path);
  // show small local preview by creating objectURL while uploading
  const tmpUrl = URL.createObjectURL(f);
  filePending = tmpUrl; // temporary; will be overwritten with final URL after upload
  // show preview in composer? skipped for brevity
  // upload
  try {
    const data = await uploadBytes(storageRef, f);
    const url = await getDownloadURL(storageRef);
    filePending = url;
    // automatically send message with image
    sendMessage();
  } catch (err){
    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + err.message);
    filePending = null;
  } finally {
    fileInput.value = "";
  }
});

/* ---------- NOTIFICATIONS (browser) ---------- */
async function notifyUser(msg){
  // request permission
  if (Notification.permission !== "granted") {
    try { await Notification.requestPermission(); } catch(e){ }
  }
  if (Notification.permission === "granted"){
    const title = msg.name || "Astik";
    const body = (msg.text && msg.text.length>80) ? msg.text.slice(0,80)+"‚Ä¶" : msg.text;
    const n = new Notification(title, { body, icon: null });
    // optional sound
    try{ if (notifySound.src) notifySound.play(); }catch(e){}
  }
}

/* ---------- ADMIN: clear chat ---------- */
btnClear.addEventListener("click", async ()=>{
  if (!currentUser) return alert("–¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏");
  if (!confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è? (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–¥–º–∏–Ω-–ø–∞—Ä–æ–ª—å)")) return;
  const pwd = prompt("–í–≤–µ–¥–∏—Ç–µ –∞–¥–º–∏–Ω-–ø–∞—Ä–æ–ª—å:");
  if (pwd !== "25") return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
  await remove(ref(db, MESSAGES));
  messagesEl.innerHTML = "";
});

/* ---------- THEME TOGGLE ---------- */
btnTheme.addEventListener("click", ()=>{
  theme = theme === "light" ? "dark" : "light";
  appRoot.setAttribute("data-theme", theme);
  localStorage.setItem("astik:theme", theme);
});

/* ---------- avatar color apply ---------- */
avatarColorInput.addEventListener("input", ()=>{
  // change avatar preview and save to DB if logged
  myAvatar.style.background = avatarColorInput.value;
  if (currentUser) set(ref(db, `${USERS}/${currentUser.uid}/avatarColor`), avatarColorInput.value);
});

/* ---------- simple search (local only) ---------- */
inputSearch.addEventListener("input", (e)=>{
  const q = e.target.value.toLowerCase();
  Array.from(contactsList.children).forEach(node => {
    node.style.display = node.textContent.toLowerCase().includes(q) ? "" : "none";
  });
});

/* ---------- init listens for anonymous presence if not auth ---------- */
(function init(){
  // populate some demo messages if DB empty? (not necessary)
  listenMessages();
  listenPresence();
  listenTyping();
})();

</script>
</body>
</html>
