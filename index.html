<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Вотсапчик</title>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#000;color:#fff;font-family:system-ui,sans-serif;height:100vh;display:flex;align-items:flex-end;justify-content:center;padding:20px 10px 40px 10px;overflow:hidden}

  #app{
    width:100%;
    max-width:460px;
    height:85vh;
    background:#0b141a;
    border-radius:28px 28px 0 0;
    overflow:hidden;
    box-shadow:0 -20px 50px rgba(0,0,0,0.8);
    position:relative;
    display:flex;
    flex-direction:column;
  }
  #app::before{
    content:'';position:absolute;top:10px;left:50%;transform:translateX(-50%);
    width:46px;height:5px;background:#555;border-radius:10px;z-index:10;
  }

  header{background:#075e54;padding:14px 16px;color:white;font-size:20px;display:flex;align-items:center;justify-content:center;position:relative}
  .change-name{position:absolute;right:16px;font-size:24px;cursor:pointer;opacity:0.8}

  #chat-list{flex:1;overflow-y:auto;background:#111;padding:10px 0}
  .chat-item{padding:14px 18px;display:flex;align-items:center;gap:14px;cursor:pointer;position:relative}
  .chat-item:active{background:#1e2a33}
  .avatar{width:56px;height:56px;border-radius:50%;background:#25d366;color:#000;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:22px}
  .info{flex:1}
  .chat-name{font-size:18px;font-weight:500}
  .last-msg{font-size:14.5px;color:#bbb;margin-top:4px}
  .unread-badge{
    background:#25d366;color:black;padding:4px 9px;border-radius:12px;font-size:12px;font-weight:bold;min-width:20px;text-align:center
  }

  #chat-screen{display:none;flex-direction:column;height:100%}
  #chat-header{background:#075e54;padding:12px 16px;display:flex;align-items:center;gap:14px;color:white;position:relative}
  #chat-header .back{position:absolute;left:12px;top:10px;font-size:28px;background:none;border:none;color:white;cursor:pointer}
  #chat-messages{flex:1;overflow-y:auto;background:#0b141a;padding:10px 8px;display:flex;flex-direction:column;gap:9px}
  .message{max-width:76%;padding:9px 14px;border-radius:18px;line-height:1.4}
  .sent{align-self:flex-end;background:#005c4b;color:white;border-bottom-right-radius:4px}
  .received{align-self:flex-start;background:#262d31;color:white;border-bottom-left-radius:4px}
  .msg-text{margin-bottom:4px}
  .msg-time{font-size:11px;opacity:0.7;text-align:right}
  .input-bar{background:#111;padding:10px 12px;display:flex;align-items:center;gap:12px}
  #msg-input{flex:1;padding:13px 18px;background:#222;border:none;border-radius:30px;color:white;font-size:16.5px}
  #send-btn{width:48px;height:48px;background:#25d366;border:none;border-radius:50%;color:black;font-size:22px}

  #welcome{background:linear-gradient(135deg,#128c7e,#25d366);position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:100}
  #welcome h1{font-size:38px;color:white;margin-bottom:20px}
  #welcome input{width:88%;padding:19px;border:none;border-radius:18px;font-size:18px;text-align:center;margin:15px 0}
  #welcome button{padding:17px 60px;background:white;color:#128c7e;border-radius:30px;font-size:19px;font-weight:bold;border:none}
</style>
</head>
<body>

<div id="app">
  <!-- Экран имени -->
  <div id="welcome">
    <h1>Вотсапчик</h1>
    <p style="color:white;font-size:19px;margin-bottom:25px">Введи своё имя</p>
    <input type="text" id="nameInput" placeholder="Твоё имя" maxlength="20">
    <button onclick="startApp()">Войти</button>
  </div>

  <!-- Список чатов -->
  <div id="main" style="display:none;height:100%;display:flex;flex-direction:column">
    <header>
      Мои чаты
      <span class="change-name" onclick="changeName()">Edit</span>
    </header>
    <div id="chat-list">
      <div class="chat-item" onclick="openPublicChat()">
        <div class="avatar">G</div>
        <div class="info">
          <div class="chat-name">Общий чат</div>
          <div class="last-msg">Нажми чтобы войти</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Переписка -->
  <div id="chat-screen" style="height:100%">
    <div id="chat-header">
      <button class="back" onclick="backToList()">Back</button>
      <div class="avatar" id="chat-avatar">A</div>
      <div class="info"><div id="chat-title">Чат</div></div>
    </div>
    <div id="chat-messages"></div>
    <div class="input-bar">
      <input type="text" id="msg-input" placeholder="Сообщение">
      <button id="send-btn">Send</button>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCysKcXFVoqWDIQzkdObB-9sgm54cRGyp0",
  authDomain: "test3-88cee.firebaseapp.com",
  databaseURL: "https://test3-88cee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test3-88cee",
  storageBucket: "test3-88cee.firebasestorage.app",
  messagingSenderId: "469479851370",
  appId: "1:469479851370:web:915e95767b012c281e1113"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let myName = localStorage.getItem('myName') || '';
let currentPath = '';
let currentChatTitle = '';
let currentChatId = null;
let unreadCounts = {}; // {chatId: количество непрочитанных}

function startApp() {
  myName = document.getElementById('nameInput').value.trim() || 'Гость';
  if (!myName) return alert('Имя нужно ввести');
  localStorage.setItem('myName', myName);
  document.getElementById('welcome').style.display = 'none';
  document.getElementById('main').style.display = 'flex';
  loadChatList();
}

function changeName() {
  const newName = prompt('Новое имя:', myName);
  if (newName && newName.trim() && newName.trim() !== myName) {
    myName = newName.trim();
    localStorage.setItem('myName', myName);
    alert('Имя изменено на: ' + myName);
    loadChatList(); // обновляем список
  }
}

function loadChatList() {
  const list = document.getElementById('chat-list');
  list.innerHTML = `<div class="chat-item" onclick="openPublicChat()">
    <div class="avatar">G</div>
    <div class="info"><div class="chat-name">Общий чат</div><div class="last-msg">Все пишут сюда</div></div>
  </div>`;

  unreadCounts = {}; // сбрасываем счётчики

  db.ref('private_chats').orderByChild('lastTime').on('child_added', snap => {
    const id = snap.key;
    const data = snap.val();
    const friend = id.split('_').find(u => u.toLowerCase() !== myName.toLowerCase());
    if (!friend) return;

    const unread = (data.unread && data.unread[myName.toLowerCase()]) || 0;
    unreadCounts[id] = unread;

    const item = document.createElement('div');
    item.className = 'chat-item';
    item.onclick = () => openPrivateChat(friend);
    item.innerHTML = `
      <div class="avatar">${friend[0].toUpperCase()}</div>
      <div class="info">
        <div class="chat-name">${friend}</div>
        <div class="last-msg">${(data.lastMsg||'Начните переписку').substr(0,36)}${(data.lastMsg||'').length>36?'...':''}</div>
      </div>
      ${unread>0 ? `<div class="unread-badge">${unread}</div>` : '<div class="time">'+formatTime(data.lastTime)+'</div>'}
    `;
    list.appendChild(item);
  });
}

function openPublicChat() {
  currentPath = 'public_messages';
  currentChatTitle = 'Общий чат';
  currentChatId = null;
  openChatScreen();
}

function openPrivateChat(friend) {
  const id = [myName, friend].sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase())).join('_');
  currentPath = `private_chats/${id}/messages`;
  currentChatTitle = friend;
  currentChatId = id;

  // Сбрасываем непрочитанные при открытии
  if (unreadCounts[id] > 0) {
    db.ref(`private_chats/${id}/unread/${myName.toLowerCase()}`).remove();
    unreadCounts[id] = 0;
  }

  openChatScreen();
}

function openChatScreen() {
  document.getElementById('main').style.display = 'none';
  document.getElementById('chat-screen').style.display = 'flex';
  document.getElementById('chat-title').textContent = currentChatTitle;
  document.getElementById('chat-avatar').textContent = currentChatTitle[0].toUpperCase();
  document.getElementById('chat-messages').innerHTML = '';

  db.ref(currentPath).orderByChild('time').limitToLast(300).on('child_added', s => {
    const m = s.val();
    if (currentChatId && m.name !== myName) {
      // Увеличиваем счётчик непрочитанных, если чат не открыт
      const ref = db.ref(`private_chats/${currentChatId}/unread/${myName.toLowerCase()}`);
      ref.transaction(v => (v||0)+1);
    }

    const div = document.createElement('div');
    div.className = `message ${m.name===myName?'sent':'received'}`;
    div.innerHTML = `<div class="msg-text">${m.text}</div><div class="msg-time">${new Date(m.time).toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'})}</div>`;
    document.getElementById('chat-messages').appendChild(div);
    div.scrollIntoView({behavior:'smooth'});
  });
}

document.getElementById('send-btn').onclick = () => {
  const text = document.getElementById('msg-input').value.trim();
  if (!text) return;
  const msg = {name: myName, text, time: Date.now()};
  db.ref(currentPath).push(msg);

  if (currentChatId) {
    const updates = {
      lastMsg: text.length>40 ? text.substr(0,37)+'...' : text,
      lastTime: Date.now()
    };
    // Увеличиваем непрочитанные у собеседника
    const friend = currentChatId.split('_').find(u => u.toLowerCase() !== myName.toLowerCase());
    if (friend) updates[`unread/${friend.toLowerCase()}`] = firebase.database.ServerValue.increment(1);
    db.ref('private_chats/'+currentChatId).update(updates);
  }

  document.getElementById('msg-input').value = '';
};

function backToList() {
  document.getElementById('chat-screen').style.display = 'none';
  document.getElementById('main').style.display = 'flex';
  setTimeout(loadChatList, 300); // небольшая задержка для красоты
}

function formatTime(t){
  if(!t) return '';
  const d = new Date(t);
  const now = new Date();
  return d.toDateString()===now.toDateString() ? d.toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'}) : d.toLocaleDateString('ru');
}

// Автовход
if (localStorage.getItem('myName')) {
  myName = localStorage.getItem('myName');
  document.getElementById('nameInput').value = myName;
  startApp();
}
</script>
</body>
</html>
