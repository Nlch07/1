<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Astik Messenger</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
.app { width: 100%; max-width: 400px; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }

/* Header */
.header { background: linear-gradient(135deg, #4a6cf7, #3a5ce5); color: white; padding: 20px; display: flex; align-items: center; gap: 15px; }
.avatar { width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; }
.header-info { flex: 1; }
.header h1 { font-size: 20px; margin-bottom: 5px; }
.header p { font-size: 14px; opacity: 0.9; }
.auth-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
.auth-btn:hover { background: rgba(255,255,255,0.3); }

/* Messages */
.messages { height: 500px; overflow-y: auto; padding: 20px; background: #f8fafc; display: flex; flex-direction: column; gap: 15px; }
.message { max-width: 85%; padding: 15px; border-radius: 18px; position: relative; animation: fadeIn 0.3s; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.message.sent { background: linear-gradient(135deg, #4a6cf7, #3a5ce5); color: white; align-self: flex-end; border-bottom-right-radius: 5px; }
.message.received { background: white; border: 1px solid #e2e8f0; align-self: flex-start; border-bottom-left-radius: 5px; }
.message-sender { font-size: 12px; font-weight: 600; margin-bottom: 5px; color: #4a6cf7; }
.message.sent .message-sender { color: rgba(255,255,255,0.9); }
.message-text { font-size: 15px; line-height: 1.4; }
.message img { max-width: 100%; border-radius: 10px; margin-top: 10px; border: 2px solid rgba(255,255,255,0.1); }
.message.sent img { border-color: rgba(255,255,255,0.2); }
.message-time { font-size: 11px; opacity: 0.7; text-align: right; margin-top: 8px; }

/* Audio Player */
.audio-message { margin-top: 10px; }
.audio-player { background: rgba(255,255,255,0.1); border-radius: 25px; padding: 12px 15px; display: flex; align-items: center; gap: 12px; }
.message.received .audio-player { background: #f1f5ff; }
.play-btn { background: white; color: #4a6cf7; border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.play-btn:hover { transform: scale(1.1); }
.audio-wave { display: flex; align-items: center; gap: 4px; height: 30px; }
.wave-bar { width: 4px; height: 20px; background: currentColor; border-radius: 2px; animation: wave 1.2s ease-in-out infinite; }
@keyframes wave { 0%,100% { height: 10px; } 50% { height: 20px; } }
.wave-bar:nth-child(2) { animation-delay: 0.2s; }
.wave-bar:nth-child(3) { animation-delay: 0.4s; }
.wave-bar:nth-child(4) { animation-delay: 0.6s; }
.wave-bar:nth-child(5) { animation-delay: 0.8s; }

/* Input Area */
.input-area { padding: 20px; background: white; border-top: 1px solid #e2e8f0; display: flex; gap: 12px; align-items: center; }
.message-input { flex: 1; padding: 15px 20px; border: 2px solid #e2e8f0; border-radius: 30px; font-size: 15px; outline: none; transition: 0.3s; }
.message-input:focus { border-color: #4a6cf7; box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1); }
.action-btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: linear-gradient(135deg, #4a6cf7, #3a5ce5); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(74, 108, 247, 0.3); }
.action-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(74, 108, 247, 0.4); }
.action-btn.recording { background: linear-gradient(135deg, #ff4757, #ff3838); animation: pulse 1.5s infinite; }
@keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }

/* Recording UI */
.recording-ui { padding: 15px; background: #fff8e1; display: none; }
.recording-box { background: white; border-radius: 15px; padding: 20px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.recording-dot { width: 14px; height: 14px; background: #ff4757; border-radius: 50%; animation: pulse 1s infinite; }
.recording-time { font-family: monospace; font-size: 18px; font-weight: bold; color: #333; }
.recording-actions { margin-left: auto; display: flex; gap: 10px; }
.record-action-btn { padding: 10px 20px; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; transition: 0.3s; }
.record-action-btn.cancel { background: #e2e8f0; color: #64748b; }
.record-action-btn.send { background: linear-gradient(135deg, #4a6cf7, #3a5ce5); color: white; }

/* Status */
.status { text-align: center; padding: 10px; color: #64748b; font-size: 13px; }

/* Scrollbar */
.messages::-webkit-scrollbar { width: 8px; }
.messages::-webkit-scrollbar-track { background: #f1f5ff; }
.messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
.messages::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

/* Responsive */
@media (max-width: 480px) {
    .app { max-width: 100%; border-radius: 0; height: 100vh; }
    .messages { height: calc(100vh - 180px); }
}
</style>
</head>
<body>
<div class="app">
    <!-- Header -->
    <div class="header">
        <div class="avatar">A</div>
        <div class="header-info">
            <h1>Astik Messenger</h1>
            <p id="statusText">–ì–æ—Ç–æ–≤ –∫ –æ–±—â–µ–Ω–∏—é</p>
        </div>
        <button class="auth-btn" id="authBtn">–í–æ–π—Ç–∏</button>
    </div>

    <!-- Messages -->
    <div class="messages" id="messages">
        <div class="message received">
            <div class="message-sender">Astik Assistant</div>
            <div class="message-text">–ü—Ä–∏–≤–µ—Ç! üëã –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —Ñ–æ—Ç–æ –∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.</div>
            <div class="message-time">–°–µ–π—á–∞—Å</div>
        </div>
    </div>

    <!-- Recording UI -->
    <div class="recording-ui" id="recordingUI">
        <div class="recording-box">
            <div class="recording-dot"></div>
            <div class="recording-time" id="recordingTime">00:00</div>
            <div class="recording-actions">
                <button class="record-action-btn cancel" onclick="cancelRecording()">–û—Ç–º–µ–Ω–∞</button>
                <button class="record-action-btn send" onclick="stopRecording()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="input-area">
        <input type="text" class="message-input" id="textInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
        <button class="action-btn" id="photoBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ">üì∑</button>
        <button class="action-btn" id="recordBtn" title="–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ">üé§</button>
        <button class="action-btn" id="sendBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept="image/*" style="display: none;">
</div>

<script>
// –õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è - —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase
let messages = JSON.parse(localStorage.getItem('astik_messages')) || [];
let currentUser = localStorage.getItem('astik_user') || '–ì–æ—Å—Ç—å_' + Math.random().toString(36).substr(2, 6);
let mediaRecorder = null;
let recordedChunks = [];
let recTimer = null;
let recStartTime = 0;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
function init() {
    loadMessages();
    document.getElementById('statusText').textContent = currentUser;
    document.getElementById('textInput').focus();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ —á–∞—Ç –ø—É—Å—Ç–æ–π
    if (messages.length === 0) {
        const welcomeMsg = {
            id: Date.now(),
            sender: 'Astik Assistant',
            text: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Astik Messenger! –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —Ñ–æ—Ç–æ –∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.',
            type: 'text',
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        };
        messages.push(welcomeMsg);
        localStorage.setItem('astik_messages', JSON.stringify(messages));
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
function loadMessages() {
    const messagesDiv = document.getElementById('messages');
    messagesDiv.innerHTML = '';
    
    messages.forEach(msg => {
        addMessageToUI(msg, false);
    });
    
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ UI
function addMessageToUI(msg, scroll = true) {
    const messagesDiv = document.getElementById('messages');
    const msgDiv = document.createElement('div');
    const isCurrentUser = msg.sender === currentUser;
    
    msgDiv.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
    msgDiv.dataset.id = msg.id || Date.now();
    
    let content = '';
    
    if (!isCurrentUser && msg.sender !== 'Astik Assistant') {
        content += `<div class="message-sender">${msg.sender}</div>`;
    }
    
    content += `<div class="message-text">${escapeHtml(msg.text)}</div>`;
    
    if (msg.type === 'photo' && msg.data) {
        content += `<img src="${msg.data}" alt="–§–æ—Ç–æ">`;
    }
    
    if (msg.type === 'audio' && msg.data) {
        content += `
            <div class="audio-message">
                <div class="audio-player">
                    <button class="play-btn" onclick="playAudio('${msg.data}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                    </button>
                    <div class="audio-wave">
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                    </div>
                </div>
            </div>
        `;
    }
    
    content += `<div class="message-time">${msg.time}</div>`;
    msgDiv.innerHTML = content;
    messagesDiv.appendChild(msgDiv);
    
    if (scroll) {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
function sendMessage() {
    const input = document.getElementById('textInput');
    const text = input.value.trim();
    if (!text) return;
    
    const msg = {
        id: Date.now(),
        sender: currentUser,
        text: text,
        type: 'text',
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
    };
    
    messages.push(msg);
    localStorage.setItem('astik_messages', JSON.stringify(messages));
    addMessageToUI(msg);
    input.value = '';
    input.focus();
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ
document.getElementById('photoBtn').onclick = () => {
    document.getElementById('fileInput').click();
};

document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const msg = {
            id: Date.now(),
            sender: currentUser,
            text: 'üì∑ –§–æ—Ç–æ',
            type: 'photo',
            data: e.target.result,
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        };
        
        messages.push(msg);
        localStorage.setItem('astik_messages', JSON.stringify(messages));
        addMessageToUI(msg);
    };
    reader.readAsDataURL(file);
    e.target.value = '';
});

// –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
document.getElementById('recordBtn').onclick = toggleRecording;

async function toggleRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        stopRecording();
    } else {
        await startRecording();
    }
}

async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: true,
                noiseSuppression: true
            }
        });
        
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        recordedChunks = [];
        
        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) recordedChunks.push(e.data);
        };
        
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const msg = {
                    id: Date.now(),
                    sender: currentUser,
                    text: 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                    type: 'audio',
                    data: e.target.result,
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                };
                
                messages.push(msg);
                localStorage.setItem('astik_messages', JSON.stringify(messages));
                addMessageToUI(msg);
            };
            
            reader.readAsDataURL(audioBlob);
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        recStartTime = Date.now();
        startTimer();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º UI –∑–∞–ø–∏—Å–∏
        document.getElementById('recordingUI').style.display = 'block';
        document.getElementById('recordBtn').classList.add('recording');
        document.getElementById('recordBtn').innerHTML = '‚èπ';
        
    } catch (err) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
        console.error(err);
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        stopTimer();
        document.getElementById('recordingUI').style.display = 'none';
        document.getElementById('recordBtn').classList.remove('recording');
        document.getElementById('recordBtn').innerHTML = 'üé§';
    }
}

function cancelRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        recordedChunks = [];
        stopTimer();
        document.getElementById('recordingUI').style.display = 'none';
        document.getElementById('recordBtn').classList.remove('recording');
        document.getElementById('recordBtn').innerHTML = 'üé§';
        
        if (mediaRecorder.stream) {
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
        }
    }
}

function startTimer() {
    recTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - recStartTime) / 1000);
        const min = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const sec = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('recordingTime').textContent = `${min}:${sec}`;
        
        // –ê–≤—Ç–æ–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 2 –º–∏–Ω—É—Ç—ã
        if (elapsed >= 120) {
            stopRecording();
        }
    }, 1000);
}

function stopTimer() {
    if (recTimer) {
        clearInterval(recTimer);
        recTimer = null;
    }
}

function playAudio(audioData) {
    const audio = new Audio(audioData);
    audio.play();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –°–æ–±—ã—Ç–∏—è
document.getElementById('authBtn').onclick = () => {
    const userName = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:', currentUser);
    if (userName && userName.trim()) {
        currentUser = userName.trim();
        localStorage.setItem('astik_user', currentUser);
        document.getElementById('statusText').textContent = currentUser;
    }
};

document.getElementById('sendBtn').onclick = sendMessage;
document.getElementById('textInput').onkeypress = (e) => {
    if (e.key === 'Enter') sendMessage();
};

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.onload = init;
</script>
</body>
</html>
