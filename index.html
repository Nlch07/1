<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Смена фона с синхронизацией</title>
<style>
  body { 
    margin: 0; 
    font-family: Arial, sans-serif; 
    transition: background 0.3s; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    height: 100vh;
  }
  .buttons { display: flex; gap: 10px; flex-wrap: wrap; }
  button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; }
  button[data-color="yellow"] { color: black; }
  #status { margin-top: 15px; font-size: 14px; }
</style>
</head>
<body>
<div>
  <div class="buttons">
    <button data-color="red" style="background:red;">Красный</button>
    <button data-color="blue" style="background:blue;">Синий</button>
    <button data-color="green" style="background:green;">Зелёный</button>
    <button data-color="yellow" style="background:gold;">Жёлтый</button>
  </div>
  <div id="status">Статус: готов</div>
</div>

<script>
const BIN_ID = '6929f844d0ea881f400654bb';
const API_KEY = '$2a$10$HMxMwoPKiOtVWm/jzd1MoeGqMRHVlcqEnIngig1Am1kUTEqGIxXdm';
const ENDPOINT = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

const statusEl = document.getElementById('status');

function setStatus(text, isError) {
  statusEl.textContent = 'Статус: ' + text;
  statusEl.style.color = isError ? 'crimson' : '#333';
}

function applyBackground(color) {
  document.body.style.background = color;
}

async function fetchCurrentBin() {
  setStatus('Загрузка...');
  try {
    const res = await fetch(ENDPOINT, {
      headers: { 'X-Master-Key': API_KEY }
    });
    if(!res.ok) throw new Error(res.status + ' ' + res.statusText);
    const data = await res.json();
    return data.record;
  } catch(err) {
    setStatus('Ошибка при загрузке: ' + err.message, true);
    return null;
  }
}

async function updateBin(color) {
  setStatus('Сохранение...');
  try {
    await fetch(ENDPOINT, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': API_KEY
      },
      body: JSON.stringify({
        currentBackground: color,
        availableBackgrounds: ["red","blue","green","yellow"]
      })
    });
    setStatus('Сохранено');
  } catch(err) {
    setStatus('Ошибка при сохранении: ' + err.message, true);
  }
}

// Инициализация при загрузке страницы
(async function init() {
  const record = await fetchCurrentBin();
  if(record && record.currentBackground) {
    applyBackground(record.currentBackground);
    setStatus('Фон загружен: ' + record.currentBackground);
  } else {
    applyBackground('white');
    setStatus('Фон по умолчанию');
  }
})();

// Обработчик кнопок
document.querySelectorAll('button[data-color]').forEach(btn => {
  btn.addEventListener('click', async () => {
    const color = btn.dataset.color;
    applyBackground(color);
    await updateBin(color);
  });
});
</script>
</body>
</html>
