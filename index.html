<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Чат с личками</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#000;color:#fff;font-family:system-ui,sans-serif;height:100vh;display:flex;flex-direction:column}
    header{padding:16px;background:#111;text-align:center;font-size:20px;position:relative}
    .back{position:absolute;top:8px;left:8px;background:none;border:none;color:#fff;font-size:32px;cursor:pointer}
    #messages{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:12px}
    .msg{max-width:80%;padding:13px 17px;border-radius:20px;line-height:1.4;position:relative}
    .my{align-self:flex-end;background:#0d8bff;border-bottom-right-radius:4px}
    .other{align-self:flex-start;background:#222;border-bottom-left-radius:4px}
    .name{
      font-weight:600;margin-bottom:6px;font-size:14px;cursor:pointer;
      padding:4px 8px;border-radius:8px;transition:0.2s;
    }
    .name:hover{background:rgba(255,255,255,0.15)}
    .name:active{transform:scale(0.95)}
    .private-btn{
      position:absolute;top:8px;right:8px;background:#7c4dff;color:#fff;
      border:none;border-radius:12px;padding:6px 12px;font-size:12px;
      opacity:0;transition:opacity 0.3s;border-radius:10px;
    }
    .msg:hover .private-btn{opacity:1}
    #input-area{padding:12px;background:#111;display:flex;gap:12px}
    input{flex:1;padding:16px 20px;background:#222;color:#fff;border:none;border-radius:30px;font-size:17px}
    button.send{width:56px;height:56px;background:#0d8bff;border:none;border-radius:50%;font-size:26px}
  </style>
</head>
<body>

  <header>
    Общий чат
  </header>

  <div id="messages"></div>

  <div id="input-area">
    <input type="text" id="message" placeholder="Напиши сообщение..." maxlength="500" autocomplete="off">
    <button class="send" id="send">Send</button>
  </div>

<script>
const firebaseConfig = { /* твоя конфигурация */
  apiKey: "AIzaSyCysKcXFVoqWDIQzkdObB-9sgm54cRGyp0",
  authDomain: "test3-88cee.firebaseapp.com",
  databaseURL: "https://test3-88cee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test3-88cee",
  storageBucket: "test3-88cee.firebasestorage.app",
  messagingSenderId: "469479851370",
  appId: "1:469479851370:web:915e95767b012c281e1113"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let myName = localStorage.getItem('myName') || prompt("Введи своё имя:", "Гость") || "Гость";
if (!localStorage.getItem('myName')) localStorage.setItem('myName', myName);

// === Общий чат ===
const publicRef = db.ref('public_messages');
publicRef.orderByChild('time').limitToLast(100).on('child_added', snap => {
  const msg = snap.val();
  addMessageToGeneralChat(msg);
});

function addMessageToGeneralChat(msg) {
  const div = document.createElement('div');
  div.className = 'msg ' + (msg.name === myName ? 'my' : 'other');

  const nameSpan = document.createElement('div');
  nameSpan.className = 'name';
  nameSpan.textContent = msg.name;
  nameSpan.onclick = () => startPrivateChatWith(msg.name);

  const text = document.createElement('div');
  text.textContent = msg.text;

  if (msg.name !== myName) {
    const btn = document.createElement('button');
    btn.textContent = 'Написать';
    btn.className = 'private-btn';
    btn.onclick = (e) => { e.stopPropagation(); startPrivateChatWith(msg.name); };
    div.appendChild(btn);
  }

  div.appendChild(nameSpan);
  div.appendChild(text);
  document.getElementById('messages').appendChild(div);
  document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
}

// === Отправка в общий чат ===
document.getElementById('send').onclick = () => {
  const text = document.getElementById('message').value.trim();
  if (!text) return;
  publicRef.push({
    name: myName,
    text: text,
    time: Date.now()
  });
  document.getElementById('message').value = '';
};
document.getElementById('message').addEventListener('keypress', e => {
  if (e.key === 'Enter') document.getElementById('send').click();
});

// === Личный чат по двум именам ===
function getChatId(name1, name2) {
  const a = name1.toLowerCase().trim();
  const b = name2.toLowerCase().trim();
  return a < b ? `${a}_${b}` : `${b}_${a}`;
}

function startPrivateChatWith(friendName) {
  if (friendName === myName) {
    alert('Это ты сам');
    return;
  }

  const chatId = getChatId(myName, friendName);
  const privatePath = `private_chats/${chatId}/messages`;

  // Переходим в личный чат (внутри того же окна)
  document)
  document.querySelector('header').textContent = `Чат с ${friendName}`;
  document.getElementById('messages').innerHTML = '<div style="text-align:center;color:#777;margin-top:30px">Загрузка переписки...</div>';

  const privateRef = db.ref(privatePath);
  privateRef.off(); // очищаем старых слушателей
  privateRef.orderByChild('time').limitToLast(100).on('child_added', snap => {
    const msg = snap.val();
    const div = document.createElement('div');
    div.className = 'msg ' + (msg.name === myName ? 'my' : 'other');
    div.innerHTML = `<div class="name">${msg.name === myName ? 'Вы' : friendName}</div><div>${msg.text}</div>`;
    document.getElementById('messages').appendChild(div);
    document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
  });

  // Меняем поведение отправки — теперь в личку
  document.getElementById('send').onclick = () => {
    const text = document.getElementById('message').value.trim();
    if (!text) return;
    privateRef.push({
      name: myName,
      text: text,
      time: Date.now()
    });
    document.getElementById('message').value = '';
  };
}

// Нажатие на ← — возврат в общий чат
document.querySelector('.back').onclick = () => location.reload();
</script>
</body>
</html>
