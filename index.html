<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Astik Messenger</title>
<style>
:root {
  --primary: #7C3AED;
  --primary-light: #8B5CF6;
  --secondary: #10B981;
  --bg: #0F172A;
  --surface: #1E293B;
  --surface-light: #334155;
  --text: #F1F5F9;
  --text-light: #94A3B8;
  --border: #475569;
  --online: #10B981;
  --away: #F59E0B;
  --offline: #94A3B8;
  --my-msg: #7C3AED;
  --other-msg: #334155;
  --danger: #EF4444;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 0;
}

.app {
  width: 100%;
  max-width: 100%;
  height: 100vh;
  background: var(--surface);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Header */
.header {
  padding: 16px;
  background: var(--surface-light);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.app-title {
  font-size: 20px;
  font-weight: 700;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.user-badge {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--surface);
  padding: 6px 12px;
  border-radius: 20px;
  cursor: pointer;
}

.user-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 12px;
}

/* Tabs */
.tabs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  background: var(--surface-light);
  padding: 4px;
  gap: 4px;
}

.tab {
  padding: 12px;
  border: none;
  background: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-light);
  cursor: pointer;
  transition: all 0.2s;
}

.tab.active {
  background: var(--surface);
  color: var(--text);
  font-weight: 600;
}

/* Online Status */
.online-status {
  padding: 12px 16px;
  background: rgba(16, 185, 129, 0.1);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--online);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.status-dot.away {
  background: var(--away);
}

.status-dot.offline {
  background: var(--offline);
  animation: none;
}

/* Online Users List */
.online-list {
  flex: 1;
  overflow-y: auto;
  display: none;
}

.online-list.active {
  display: block;
}

.user-item {
  display: flex;
  align-items: center;
  padding: 16px;
  gap: 12px;
  border-bottom: 1px solid var(--border);
}

.user-item:hover {
  background: var(--surface-light);
}

.user-avatar.medium {
  width: 44px;
  height: 44px;
  font-size: 16px;
}

.user-info {
  flex: 1;
}

.user-name {
  font-weight: 600;
  font-size: 16px;
  margin-bottom: 4px;
}

.user-status {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--text-light);
}

/* Chat Container */
.chat-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  display: none;
}

.chat-container.active {
  display: flex;
}

.chat-header {
  padding: 16px;
  background: var(--surface-light);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
}

.back-btn {
  background: none;
  border: none;
  color: var(--text);
  font-size: 20px;
  cursor: pointer;
}

.chat-info {
  flex: 1;
}

.chat-title {
  font-weight: 600;
  font-size: 16px;
  margin-bottom: 4px;
}

.chat-status {
  font-size: 12px;
  color: var(--text-light);
  display: flex;
  align-items: center;
  gap: 6px;
}

/* Messages */
.messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  background: var(--bg);
}

.message {
  max-width: 85%;
  padding: 12px 16px;
  border-radius: 18px;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message.sent {
  align-self: flex-end;
  background: var(--my-msg);
  border-bottom-right-radius: 4px;
}

.message.received {
  align-self: flex-start;
  background: var(--other-msg);
  border-bottom-left-radius: 4px;
}

.message-sender {
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--primary-light);
}

.message-time {
  font-size: 11px;
  opacity: 0.7;
  text-align: right;
  margin-top: 4px;
}

/* Input */
.input-area {
  padding: 16px;
  background: var(--surface);
  border-top: 1px solid var(--border);
  display: flex;
  gap: 12px;
  align-items: center;
}

.message-input {
  flex: 1;
  padding: 12px 16px;
  background: var(--surface-light);
  border: 2px solid var(--border);
  border-radius: 24px;
  color: var(--text);
  font-size: 15px;
  outline: none;
}

.message-input:focus {
  border-color: var(--primary);
}

.send-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--primary);
  border: none;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform 0.2s;
}

.send-btn:hover {
  transform: scale(1.05);
}

.send-btn:active {
  transform: scale(0.95);
}

/* Settings Panel */
.settings-panel {
  position: fixed;
  top: 0;
  right: -100%;
  width: 300px;
  height: 100%;
  background: var(--surface);
  border-left: 1px solid var(--border);
  padding: 24px;
  transition: right 0.3s;
  z-index: 1000;
}

.settings-panel.active {
  right: 0;
}

.settings-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
}

.settings-title {
  font-size: 18px;
  font-weight: 600;
}

.close-btn {
  background: none;
  border: none;
  color: var(--text);
  font-size: 20px;
  cursor: pointer;
}

.setting-item {
  margin-bottom: 20px;
}

.setting-label {
  display: block;
  margin-bottom: 8px;
  color: var(--text-light);
  font-size: 14px;
}

.setting-input {
  width: 100%;
  padding: 12px;
  background: var(--surface-light);
  border: 2px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-size: 14px;
}

.save-btn {
  width: 100%;
  padding: 14px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 24px;
}

/* Overlay */
.overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  z-index: 999;
}

.overlay.active {
  display: block;
}

/* Status Colors */
.status-online {
  color: var(--online);
}

.status-away {
  color: var(--away);
}

.status-offline {
  color: var(--offline);
}

/* Scrollbar */
.online-list::-webkit-scrollbar,
.messages-container::-webkit-scrollbar {
  width: 6px;
}

.online-list::-webkit-scrollbar-track,
.messages-container::-webkit-scrollbar-track {
  background: transparent;
}

.online-list::-webkit-scrollbar-thumb,
.messages-container::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 3px;
}

@media (max-height: 700px) {
  .user-item {
    padding: 12px 16px;
  }
  
  .message {
    padding: 10px 14px;
  }
}
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <div class="header">
    <div class="app-title">Astik Messenger</div>
    <div class="user-badge" id="userBadge">
      <div class="user-avatar" id="headerAvatar">?</div>
      <span id="headerUsername">Вход...</span>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="online">Онлайн</button>
    <button class="tab" data-tab="general">Общий чат</button>
  </div>

  <!-- Online Status -->
  <div class="online-status">
    <div class="status-dot" id="statusDot"></div>
    <span id="onlineCount">Загрузка...</span>
  </div>

  <!-- Online Users -->
  <div class="online-list active" id="onlineContainer">
    <!-- Users will appear here -->
  </div>

  <!-- General Chat -->
  <div class="chat-container" id="generalChat">
    <div class="chat-header">
      <button class="back-btn" data-back="tabs">←</button>
      <div class="chat-info">
        <div class="chat-title">Общий чат</div>
        <div class="chat-status">
          <span id="generalStatus">Все участники</span>
        </div>
      </div>
    </div>
    
    <div class="messages-container" id="generalMessages">
      <!-- Messages will appear here -->
    </div>
    
    <div class="input-area">
      <input type="text" class="message-input" id="generalInput" placeholder="Написать сообщение..." autocomplete="off">
      <button class="send-btn" id="sendGeneralBtn">➤</button>
    </div>
  </div>
</div>

<!-- Settings Panel -->
<div class="overlay" id="overlay"></div>
<div class="settings-panel" id="settingsPanel">
  <div class="settings-header">
    <div class="settings-title">Настройки</div>
    <button class="close-btn" id="closeSettingsBtn">×</button>
  </div>
  
  <div class="setting-item">
    <label class="setting-label">Ваш никнейм</label>
    <input type="text" class="setting-input" id="nicknameInput" maxlength="20" autocomplete="off">
    <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">Будет виден другим пользователям</div>
  </div>
  
  <button class="save-btn" id="saveSettingsBtn">Сохранить</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, push, onChildAdded, onValue, remove, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCysKcXFVoqWDIQzkdObB-9sgm54cRGyp0",
  authDomain: "test3-88cee.firebaseapp.com",
  databaseURL: "https://test3-88cee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test3-88cee",
  storageBucket: "test3-88cee.appspot.com",
  messagingSenderId: "469479851370",
  appId: "1:469479851370:web:915e95767b012c281e1113"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// DOM Elements
const tabs = document.querySelectorAll('.tab');
const onlineContainer = document.getElementById('onlineContainer');
const generalChat = document.getElementById('generalChat');
const userBadge = document.getElementById('userBadge');
const headerAvatar = document.getElementById('headerAvatar');
const headerUsername = document.getElementById('headerUsername');
const onlineCount = document.getElementById('onlineCount');
const statusDot = document.getElementById('statusDot');
const generalInput = document.getElementById('generalInput');
const sendGeneralBtn = document.getElementById('sendGeneralBtn');
const generalMessages = document.getElementById('generalMessages');
const settingsPanel = document.getElementById('settingsPanel');
const overlay = document.getElementById('overlay');
const nicknameInput = document.getElementById('nicknameInput');
const saveSettingsBtn = document.getElementById('saveSettingsBtn');
const closeSettingsBtn = document.getElementById('closeSettingsBtn');

// User state
let currentUser = {
  id: null,
  name: null,
  isOnline: false,
  lastActivity: Date.now()
};

let onlineUsers = {};
let activityCheckInterval = null;

// Check saved nickname on load
window.addEventListener('load', () => {
  const savedNickname = localStorage.getItem('astik_nickname');
  if (savedNickname) {
    loginUser(savedNickname);
  } else {
    setTimeout(() => openSettings(), 500);
  }
});

// Open settings when clicking user badge
userBadge.addEventListener('click', openSettings);

function openSettings() {
  const currentNickname = localStorage.getItem('astik_nickname') || '';
  nicknameInput.value = currentNickname;
  nicknameInput.focus();
  settingsPanel.classList.add('active');
  overlay.classList.add('active');
}

function closeSettings() {
  settingsPanel.classList.remove('active');
  overlay.classList.remove('active');
}

closeSettingsBtn.addEventListener('click', closeSettings);
overlay.addEventListener('click', closeSettings);

saveSettingsBtn.addEventListener('click', () => {
  const nickname = nicknameInput.value.trim();
  if (!nickname) {
    alert('Введите никнейм');
    return;
  }
  
  localStorage.setItem('astik_nickname', nickname);
  
  if (currentUser.id) {
    updateUserNickname(nickname);
  } else {
    loginUser(nickname);
  }
  
  closeSettings();
});

function loginUser(nickname) {
  currentUser.id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  currentUser.name = nickname;
  currentUser.isOnline = true;
  currentUser.lastActivity = Date.now();

  // Update header
  headerAvatar.textContent = nickname.charAt(0).toUpperCase();
  headerUsername.textContent = nickname;

  // Save user to database
  const userRef = ref(db, `users/${currentUser.id}`);
  set(userRef, {
    name: nickname,
    isOnline: true,
    lastActivity: Date.now(),
    lastSeen: Date.now(),
    status: 'online',
    avatarColor: getRandomColor()
  });

  // Start listening
  startListening();
  startActivityChecker();
}

function updateUserNickname(nickname) {
  currentUser.name = nickname;
  
  // Update header
  headerAvatar.textContent = nickname.charAt(0).toUpperCase();
  headerUsername.textContent = nickname;
  
  // Update in database
  updateUserActivity();
}

function getRandomColor() {
  const colors = ['#7C3AED', '#10B981', '#F59E0B', '#EF4444', '#3B82F6', '#8B5CF6', '#EC4899'];
  return colors[Math.floor(Math.random() * colors.length)];
}

function startListening() {
  loadOnlineUsers();
  loadGeneralMessages();
  setupPresence();
}

// Tab switching
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    const tabName = tab.dataset.tab;
    
    // Update tabs
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    
    if (tabName === 'general') {
      // Switch to general chat
      onlineContainer.classList.remove('active');
      generalChat.classList.add('active');
      generalInput.focus();
    } else {
      // Switch to online list
      generalChat.classList.remove('active');
      onlineContainer.classList.add('active');
    }
  });
});

// Back button in chat
document.querySelector('.back-btn').addEventListener('click', () => {
  generalChat.classList.remove('active');
  onlineContainer.classList.add('active');
  tabs.forEach(t => t.classList.remove('active'));
  document.querySelector('[data-tab="online"]').classList.add('active');
});

// Load online users with status management
function loadOnlineUsers() {
  const usersRef = ref(db, 'users');
  
  onValue(usersRef, (snapshot) => {
    const users = snapshot.val();
    onlineUsers = users || {};
    
    // Check for inactive users (more than 1 minute)
    const now = Date.now();
    Object.entries(onlineUsers).forEach(([userId, userData]) => {
      if (userData.isOnline && userData.lastActivity) {
        const timeSinceActivity = now - userData.lastActivity;
        if (timeSinceActivity > 60000) { // 1 minute
          // Mark as offline
          const userRef = ref(db, `users/${userId}`);
          set(userRef, {
            ...userData,
            isOnline: false,
            status: 'offline'
          });
        } else if (timeSinceActivity > 30000) { // 30 seconds
          // Mark as away
          const userRef = ref(db, `users/${userId}`);
          set(userRef, {
            ...userData,
            status: 'away'
          });
        }
      }
    });
    
    // Update online count
    const activeUsers = Object.values(onlineUsers).filter(user => 
      user.isOnline && user.lastActivity && (now - user.lastActivity <= 60000)
    ).length;
    
    onlineCount.textContent = `${activeUsers} пользователей онлайн`;
    
    // Update current user status dot
    if (currentUser.id && onlineUsers[currentUser.id]) {
      const userStatus = getUserStatus(onlineUsers[currentUser.id]);
      updateStatusDot(userStatus);
    }
    
    // Clear and rebuild list
    onlineContainer.innerHTML = '';
    
    // Add current user first
    if (currentUser.id && onlineUsers[currentUser.id]) {
      addUserToList(currentUser.id, onlineUsers[currentUser.id], true);
    }
    
    // Add other active users (online in last minute)
    Object.entries(onlineUsers).forEach(([userId, userData]) => {
      if (userId !== currentUser.id) {
        const timeSinceActivity = now - (userData.lastActivity || 0);
        if (timeSinceActivity <= 60000) { // Show only if active in last minute
          addUserToList(userId, userData, false);
        }
      }
    });
    
    // If no other users online
    if (Object.keys(onlineUsers).length <= 1) {
      onlineContainer.innerHTML += `
        <div style="text-align: center; padding: 40px 20px; color: var(--text-light);">
          <p>Другие пользователи не в сети</p>
          <p style="font-size: 13px; margin-top: 8px;">Пригласите друзей присоединиться!</p>
        </div>
      `;
    }
  });
}

function getUserStatus(userData) {
  if (!userData.isOnline) return 'offline';
  
  const now = Date.now();
  const timeSinceActivity = now - (userData.lastActivity || 0);
  
  if (timeSinceActivity > 60000) return 'offline';
  if (timeSinceActivity > 30000) return 'away';
  return 'online';
}

function updateStatusDot(status) {
  statusDot.className = 'status-dot';
  if (status === 'online') {
    statusDot.style.background = 'var(--online)';
  } else if (status === 'away') {
    statusDot.classList.add('away');
  } else {
    statusDot.classList.add('offline');
  }
}

function addUserToList(userId, userData, isCurrentUser) {
  const userItem = document.createElement('div');
  userItem.className = 'user-item';
  
  const avatarLetter = userData.name ? userData.name.charAt(0).toUpperCase() : '?';
  const status = getUserStatus(userData);
  const statusText = getStatusText(status, userData.lastActivity);
  const statusClass = `status-${status}`;
  
  userItem.innerHTML = `
    <div class="user-avatar medium" style="background: ${userData.avatarColor || getRandomColor()};">${avatarLetter}</div>
    <div class="user-info">
      <div class="user-name">${userData.name} ${isCurrentUser ? '(Вы)' : ''}</div>
      <div class="user-status">
        <div class="status-dot ${status}"></div>
        <span class="${statusClass}">${statusText}</span>
      </div>
    </div>
  `;
  
  onlineContainer.appendChild(userItem);
}

function getStatusText(status, lastActivity) {
  const now = Date.now();
  const timeDiff = now - lastActivity;
  
  switch(status) {
    case 'online':
      if (timeDiff < 10000) return 'Только что';
      if (timeDiff < 30000) return 'Онлайн';
      return 'Недавно';
    case 'away':
      return 'Нет активности';
    case 'offline':
      const minutes = Math.floor(timeDiff / 60000);
      if (minutes < 60) return `Был ${minutes} мин назад`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `Был ${hours} ч назад`;
      return 'Давно не в сети';
    default:
      return 'Оффлайн';
  }
}

// Load general messages
function loadGeneralMessages() {
  const messagesRef = ref(db, 'messages/general');
  generalMessages.innerHTML = '';
  
  onChildAdded(messagesRef, (snapshot) => {
    const message = snapshot.val();
    if (message) {
      addMessageToContainer(message, generalMessages);
    }
  });
}

function addMessageToContainer(message, container) {
  const messageDiv = document.createElement('div');
  const isSent = message.senderId === currentUser.id;
  
  messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
  
  const time = new Date(message.timestamp).toLocaleTimeString([], { 
    hour: '2-digit', 
    minute: '2-digit' 
  });
  
  if (!isSent) {
    const senderName = onlineUsers[message.senderId]?.name || 'Аноним';
    messageDiv.innerHTML = `
      <div class="message-sender">${senderName}</div>
      <div>${message.text}</div>
      <div class="message-time">${time}</div>
    `;
  } else {
    messageDiv.innerHTML = `
      <div>${message.text}</div>
      <div class="message-time">${time}</div>
    `;
  }
  
  container.appendChild(messageDiv);
  container.scrollTop = container.scrollHeight;
}

// Send general message
sendGeneralBtn.addEventListener('click', sendGeneralMessage);
generalInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') sendGeneralMessage();
});

function sendGeneralMessage() {
  const text = generalInput.value.trim();
  if (!text || !currentUser.id) return;
  
  const messagesRef = ref(db, 'messages/general');
  push(messagesRef, {
    senderId: currentUser.id,
    text: text,
    timestamp: Date.now()
  });
  
  generalInput.value = '';
  updateUserActivity();
}

// Update user activity
function updateUserActivity() {
  if (!currentUser.id) return;
  
  currentUser.lastActivity = Date.now();
  
  const userRef = ref(db, `users/${currentUser.id}`);
  set(userRef, {
    name: currentUser.name,
    isOnline: true,
    lastActivity: currentUser.lastActivity,
    lastSeen: Date.now(),
    status: 'online',
    avatarColor: getRandomColor()
  });
}

// Start activity checker
function startActivityChecker() {
  // Update activity every 10 seconds
  activityCheckInterval = setInterval(() => {
    if (currentUser.id) {
      const now = Date.now();
      const timeSinceActivity = now - currentUser.lastActivity;
      
      // If user was active in last 30 seconds, update activity
      if (timeSinceActivity < 30000) {
        updateUserActivity();
      }
    }
  }, 10000);
}

// Setup presence tracking
function setupPresence() {
  // Update activity on user interaction
  document.addEventListener('click', updateUserActivity);
  document.addEventListener('keydown', updateUserActivity);
  document.addEventListener('mousemove', throttle(updateUserActivity, 5000));
  
  // Mark as offline when leaving
  window.addEventListener('beforeunload', () => {
    if (currentUser.id) {
      const userRef = ref(db, `users/${currentUser.id}`);
      set(userRef, {
        name: currentUser.name,
        isOnline: false,
        lastActivity: Date.now(),
        lastSeen: Date.now(),
        status: 'offline',
        avatarColor: getRandomColor()
      });
      
      if (activityCheckInterval) {
        clearInterval(activityCheckInterval);
      }
    }
  });
}

// Throttle function for mousemove
function throttle(func, limit) {
  let inThrottle;
  return function() {
    const args = arguments;
    const context = this;
    if (!inThrottle) {
      func.apply(context, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
}

// Focus input when opening chat
document.querySelector('[data-tab="general"]').addEventListener('click', () => {
  setTimeout(() => generalInput.focus(), 100);
});

// Auto-focus nickname input in settings
function openSettings() {
  const currentNickname = localStorage.getItem('astik_nickname') || '';
  nicknameInput.value = currentNickname;
  settingsPanel.classList.add('active');
  overlay.classList.add('active');
  setTimeout(() => nicknameInput.focus(), 300);
}
</script>
</body>
</html>
