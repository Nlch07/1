<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Astik Messenger</title>
<style>
:root {
  --primary: #4a6cf7;
  --primary-dark: #3a5ce5;
  --secondary: #f1f5ff;
  --bg: #f8fafc;
  --white: #ffffff;
  --gray-light: #e2e8f0;
  --gray: #94a3b8;
  --gray-dark: #64748b;
  --black: #1e293b;
  --success: #10b981;
  --danger: #ef4444;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  --radius: 16px;
  --radius-sm: 10px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--black);
  line-height: 1.5;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 16px;
}

.app {
  width: 100%;
  max-width: 380px;
  height: 85vh;
  min-height: 600px;
  background: var(--white);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Header */
.header {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  padding: 14px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  position: relative;
}

.avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 16px;
  backdrop-filter: blur(10px);
}

.header-info {
  flex: 1;
}

.header-info h1 {
  font-size: 17px;
  font-weight: 600;
  margin-bottom: 2px;
}

.header-info p {
  font-size: 12px;
  opacity: 0.9;
}

.auth-buttons {
  display: flex;
  gap: 8px;
}

.auth-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
}

.auth-btn:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* Messages Container */
.messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  background: var(--bg);
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.message {
  max-width: 85%;
  padding: 12px;
  border-radius: var(--radius-sm);
  position: relative;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.message.received {
  background: var(--white);
  border: 1px solid var(--gray-light);
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}

.message.sent {
  background: var(--primary);
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}

.message-sender {
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--primary);
}

.message.sent .message-sender {
  color: rgba(255, 255, 255, 0.9);
}

.message-text {
  font-size: 14px;
  word-break: break-word;
}

.message-time {
  font-size: 11px;
  opacity: 0.7;
  text-align: right;
  margin-top: 6px;
}

/* Audio Message */
.audio-message {
  margin-top: 8px;
}

.audio-player {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  padding: 8px 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 200px;
}

.message.received .audio-player {
  background: var(--secondary);
}

.audio-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

.play-btn {
  background: var(--primary);
  color: white;
  border: none;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform 0.2s;
}

.play-btn:hover {
  transform: scale(1.1);
}

.audio-info {
  flex: 1;
}

.audio-duration {
  font-size: 12px;
  font-weight: 500;
}

.audio-wave {
  display: flex;
  align-items: center;
  gap: 2px;
  height: 24px;
}

.wave-bar {
  width: 3px;
  background: currentColor;
  border-radius: 2px;
  opacity: 0.6;
  animation: wave 1.2s ease-in-out infinite;
}

@keyframes wave {
  0%, 100% { height: 8px; }
  50% { height: 16px; }
}

.wave-bar:nth-child(2) { animation-delay: 0.2s; }
.wave-bar:nth-child(3) { animation-delay: 0.4s; }
.wave-bar:nth-child(4) { animation-delay: 0.6s; }
.wave-bar:nth-child(5) { animation-delay: 0.8s; }

/* Recording UI */
.recording-ui {
  padding: 12px 16px;
  background: var(--white);
  border-top: 1px solid var(--gray-light);
  display: none;
}

.recording-box {
  background: var(--secondary);
  border-radius: var(--radius-sm);
  padding: 14px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.recording-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
}

.recording-dot {
  width: 12px;
  height: 12px;
  background: var(--danger);
  border-radius: 50%;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.recording-time {
  font-family: 'SF Mono', monospace;
  font-size: 14px;
  font-weight: 600;
  color: var(--black);
}

.recording-actions {
  margin-left: auto;
  display: flex;
  gap: 8px;
}

.record-btn {
  background: var(--danger);
  color: white;
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.record-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.cancel-btn {
  background: var(--gray);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
}

.cancel-btn:hover {
  background: var(--gray-dark);
}

/* Input Area */
.input-area {
  padding: 12px 16px;
  background: var(--white);
  border-top: 1px solid var(--gray-light);
  display: flex;
  gap: 8px;
}

.message-input {
  flex: 1;
  padding: 10px 16px;
  border: 1px solid var(--gray-light);
  border-radius: 24px;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s;
  background: var(--bg);
}

.message-input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
}

.action-buttons {
  display: flex;
  gap: 8px;
}

.icon-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: none;
  background: var(--primary);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.icon-btn:hover {
  background: var(--primary-dark);
  transform: scale(1.05);
}

.icon-btn.recording {
  background: var(--danger);
  animation: pulse 2s infinite;
}

.icon-btn svg {
  width: 20px;
  height: 20px;
}

/* Status Indicator */
.status-indicator {
  font-size: 11px;
  padding: 4px 8px;
  background: var(--secondary);
  border-radius: 12px;
  text-align: center;
  margin: 8px auto;
  color: var(--gray-dark);
  max-width: fit-content;
}

/* Scrollbar */
.messages-container::-webkit-scrollbar {
  width: 6px;
}

.messages-container::-webkit-scrollbar-track {
  background: transparent;
}

.messages-container::-webkit-scrollbar-thumb {
  background: var(--gray-light);
  border-radius: 3px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
  background: var(--gray);
}

/* Responsive */
@media (max-height: 700px) {
  .app {
    height: 95vh;
    min-height: 500px;
  }
  
  .messages-container {
    padding: 12px;
  }
  
  .message {
    padding: 10px;
  }
}
</style>
</head>
<body>
<div class="app" id="app">
  <!-- Header -->
  <div class="header">
    <div class="avatar">A</div>
    <div class="header-info">
      <h1>Astik Messenger</h1>
      <p id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</p>
    </div>
    <div class="auth-buttons">
      <button id="btnSignIn" class="auth-btn">–í–æ–π—Ç–∏</button>
      <button id="btnSignOut" class="auth-btn" style="display:none">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <!-- Messages -->
  <div class="messages-container" id="messagesContainer">
    <div class="status-indicator" id="connectionStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —á–∞—Ç—É...</div>
  </div>

  <!-- Recording UI -->
  <div class="recording-ui" id="recordingUI">
    <div class="recording-box">
      <div class="recording-indicator">
        <div class="recording-dot"></div>
        <div class="recording-time" id="recordingTime">00:00</div>
      </div>
      <div class="recording-actions">
        <button class="cancel-btn" id="btnCancelRec">–û—Ç–º–µ–Ω–∞</button>
        <button class="record-btn" id="btnSendRec">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Input Area -->
  <div class="input-area">
    <input type="text" class="message-input" id="inputMessage" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
    <div class="action-buttons">
      <button class="icon-btn" id="btnRecord" title="–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
        </svg>
      </button>
      <button class="icon-btn" id="btnSend" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCysKcXFVoqWDIQzkdObB-9sgm54cRGyp0",
  authDomain: "test3-88cee.firebaseapp.com",
  databaseURL: "https://test3-88cee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test3-88cee",
  storageBucket: "test3-88cee.appspot.com",
  messagingSenderId: "469479851370",
  appId: "1:469479851370:web:915e95767b012c281e1113"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const storage = getStorage(app);

// DOM Elements
const messagesContainer = document.getElementById('messagesContainer');
const inputMessage = document.getElementById('inputMessage');
const btnSend = document.getElementById('btnSend');
const btnRecord = document.getElementById('btnRecord');
const btnSignIn = document.getElementById('btnSignIn');
const btnSignOut = document.getElementById('btnSignOut');
const recordingUI = document.getElementById('recordingUI');
const recordingTime = document.getElementById('recordingTime');
const btnCancelRec = document.getElementById('btnCancelRec');
const btnSendRec = document.getElementById('btnSendRec');
const statusText = document.getElementById('statusText');
const connectionStatus = document.getElementById('connectionStatus');

// State
let currentUser = null;
let localDeviceId = "dev_" + Math.random().toString(36).slice(2, 9);
let mediaRecorder = null;
let recordedChunks = [];
let recStartTs = 0;
let recTimer = null;
let audioStream = null;
let activeAudios = new Map();

// Auth
btnSignIn.addEventListener('click', async () => {
  try {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
    connectionStatus.textContent = "–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ";
  } catch (error) {
    console.error('Auth error:', error);
    connectionStatus.textContent = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞";
  }
});

btnSignOut.addEventListener('click', () => {
  signOut(auth);
  connectionStatus.textContent = "–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞";
});

onAuthStateChanged(auth, (user) => {
  currentUser = user;
  btnSignIn.style.display = user ? 'none' : 'block';
  btnSignOut.style.display = user ? 'block' : 'none';
  statusText.textContent = user ? `–í—ã: ${user.displayName}` : '–ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º';
  
  if (user) {
    connectionStatus.textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user.displayName}!`;
    setTimeout(() => {
      connectionStatus.style.display = 'none';
    }, 2000);
  }
});

// Messages
function formatTime(timestamp) {
  const date = new Date(timestamp);
  return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
}

function createMessageElement(msg) {
  const isSent = msg.senderId === (currentUser ? currentUser.uid : localDeviceId);
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
  
  const senderName = msg.name || (isSent ? '–í—ã' : '–ì–æ—Å—Ç—å');
  
  messageDiv.innerHTML = `
    ${!isSent ? `<div class="message-sender">${senderName}</div>` : ''}
    <div class="message-text">${msg.type === 'audio' ? 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ' : escapeHtml(msg.text)}</div>
    ${msg.type === 'audio' && msg.audioUrl ? `
      <div class="audio-message">
        <div class="audio-player">
          <div class="audio-controls">
            <button class="play-btn" data-audio="${msg.audioUrl}">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
            </button>
          </div>
          <div class="audio-info">
            <div class="audio-wave">
              <div class="wave-bar"></div>
              <div class="wave-bar"></div>
              <div class="wave-bar"></div>
              <div class="wave-bar"></div>
              <div class="wave-bar"></div>
            </div>
            <div class="audio-duration" data-audio="${msg.audioUrl}">...</div>
          </div>
        </div>
      </div>
    ` : ''}
    <div class="message-time">${formatTime(msg.time)}</div>
  `;
  
  return messageDiv;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Listen for new messages
const messagesRef = ref(db, 'messages');
onChildAdded(messagesRef, (snapshot) => {
  const msg = snapshot.val();
  const messageElement = createMessageElement(msg);
  messagesContainer.appendChild(messageElement);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  // Load audio duration for audio messages
  if (msg.type === 'audio' && msg.audioUrl) {
    loadAudioDuration(msg.audioUrl);
  }
  
  // Add click handler for play buttons
  setTimeout(() => {
    const playBtn = messageElement.querySelector(`[data-audio="${msg.audioUrl}"]`);
    if (playBtn) {
      playBtn.addEventListener('click', () => toggleAudioPlayback(msg.audioUrl));
    }
  }, 100);
});

// Audio playback
async function toggleAudioPlayback(audioUrl) {
  const audioElement = activeAudios.get(audioUrl);
  
  if (audioElement && !audioElement.paused) {
    audioElement.pause();
    return;
  }
  
  // Stop all other audios
  activeAudios.forEach((audio, url) => {
    if (url !== audioUrl) {
      audio.pause();
      audio.currentTime = 0;
    }
  });
  
  const audio = new Audio(audioUrl);
  activeAudios.set(audioUrl, audio);
  
  audio.addEventListener('loadedmetadata', () => {
    const durationElements = document.querySelectorAll(`[data-audio="${audioUrl}"]`);
    durationElements.forEach(el => {
      if (el.className === 'audio-duration') {
        el.textContent = formatDuration(audio.duration);
      }
    });
  });
  
  audio.addEventListener('ended', () => {
    activeAudios.delete(audioUrl);
  });
  
  try {
    await audio.play();
  } catch (error) {
    console.error('Audio playback error:', error);
  }
}

function formatDuration(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

async function loadAudioDuration(audioUrl) {
  try {
    const audio = new Audio(audioUrl);
    audio.addEventListener('loadedmetadata', () => {
      const durationElements = document.querySelectorAll(`[data-audio="${audioUrl}"]`);
      durationElements.forEach(el => {
        if (el.className === 'audio-duration') {
          el.textContent = formatDuration(audio.duration);
        }
      });
    });
  } catch (error) {
    console.error('Error loading audio duration:', error);
  }
}

// Send text message
btnSend.addEventListener('click', sendTextMessage);
inputMessage.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') sendTextMessage();
});

async function sendTextMessage() {
  const text = inputMessage.value.trim();
  if (!text) return;
  
  try {
    await push(messagesRef, {
      senderId: currentUser ? currentUser.uid : localDeviceId,
      name: currentUser ? currentUser.displayName : '–ì–æ—Å—Ç—å',
      type: 'text',
      text: text,
      time: Date.now()
    });
    
    inputMessage.value = '';
    inputMessage.focus();
  } catch (error) {
    console.error('Error sending message:', error);
    connectionStatus.textContent = "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è";
    connectionStatus.style.display = 'block';
  }
}

// Voice recording
btnRecord.addEventListener('click', () => {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    stopRecording();
  } else {
    startRecording();
  }
});

async function startRecording() {
  try {
    if (audioStream) {
      audioStream.getTracks().forEach(track => track.stop());
    }
    
    audioStream = await navigator.mediaDevices.getUserMedia({ 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      }
    });
    
    mediaRecorder = new MediaRecorder(audioStream, {
      mimeType: 'audio/webm;codecs=opus'
    });
    
    recordedChunks = [];
    
    mediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) {
        recordedChunks.push(event.data);
      }
    };
    
    mediaRecorder.onstop = async () => {
      const audioBlob = new Blob(recordedChunks, { type: 'audio/webm;codecs=opus' });
      await uploadAudioMessage(audioBlob);
      
      if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
        audioStream = null;
      }
    };
    
    mediaRecorder.start(100); // Collect data every 100ms
    recStartTs = Date.now();
    startRecordingTimer();
    
    // Update UI
    recordingUI.style.display = 'block';
    btnRecord.classList.add('recording');
    btnRecord.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="6" y="6" width="12" height="12" rx="2"></rect>
      </svg>
    `;
    
  } catch (error) {
    console.error('Recording error:', error);
    connectionStatus.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É";
    connectionStatus.style.display = 'block';
    setTimeout(() => {
      connectionStatus.style.display = 'none';
    }, 3000);
  }
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    stopRecordingTimer();
    
    // Update UI
    recordingUI.style.display = 'none';
    btnRecord.classList.remove('recording');
    btnRecord.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
      </svg>
    `;
  }
}

function startRecordingTimer() {
  recTimer = setInterval(() => {
    const elapsed = Math.floor((Date.now() - recStartTs) / 1000);
    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
    const seconds = (elapsed % 60).toString().padStart(2, '0');
    recordingTime.textContent = `${minutes}:${seconds}`;
    
    // Auto-stop after 2 minutes
    if (elapsed >= 120) {
      stopRecording();
    }
  }, 1000);
}

function stopRecordingTimer() {
  if (recTimer) {
    clearInterval(recTimer);
    recTimer = null;
  }
}

btnCancelRec.addEventListener('click', () => {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    recordedChunks = [];
    stopRecordingTimer();
    recordingUI.style.display = 'none';
    btnRecord.classList.remove('recording');
    btnRecord.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
      </svg>
    `;
    
    if (audioStream) {
      audioStream.getTracks().forEach(track => track.stop());
      audioStream = null;
    }
  }
});

btnSendRec.addEventListener('click', () => {
  stopRecording();
});

async function uploadAudioMessage(audioBlob) {
  try {
    const userId = currentUser ? currentUser.uid : localDeviceId;
    const timestamp = Date.now();
    const storagePath = `audio/${userId}/${timestamp}.webm`;
    const storageRef = sref(storage, storagePath);
    
    await uploadBytes(storageRef, audioBlob);
    const audioUrl = await getDownloadURL(storageRef);
    
    await push(messagesRef, {
      senderId: userId,
      name: currentUser ? currentUser.displayName : '–ì–æ—Å—Ç—å',
      type: 'audio',
      audioUrl: audioUrl,
      time: timestamp,
      duration: Math.floor((Date.now() - recStartTs) / 1000)
    });
    
  } catch (error) {
    console.error('Error uploading audio:', error);
    connectionStatus.textContent = "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è";
    connectionStatus.style.display = 'block';
    setTimeout(() => {
      connectionStatus.style.display = 'none';
    }, 3000);
  }
}

// Initialize
connectionStatus.textContent = "–ß–∞—Ç –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é";
setTimeout(() => {
  connectionStatus.style.display = 'none';
}, 2000);

// Focus input on load
inputMessage.focus();
</script>
</body>
</html>
