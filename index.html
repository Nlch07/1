<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>AstikMessenger</title>
<style>
  /* Root colors and theme */
  :root{
    --bg:#f1f6fb;
    --card:#ffffff;
    --accent1:#3a7bd5;
    --accent2:#00d2ff;
    --me:#d0eaff;
    --text:#0b1220;
    --muted:#667085;
  }
  [data-theme="dark"]{
    --bg:#071025; --card:#061226; --me:#07324b; --text:#e6eef7; --muted:#9fb0cc;
  }

  html, body{
    margin:0; padding:0; height:100%; font-family:Inter,Roboto,sans-serif; background:var(--bg); color:var(--text);
  }

  .app{
    max-width:640px; margin:0 auto; height:100vh; display:flex; flex-direction:column; border-radius:12px; overflow:hidden; box-shadow:0 8px 20px rgba(0,0,0,0.08);
  }

  /* Header */
  .header{ display:flex; align-items:center; padding:12px; background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:white; }
  .logo{ width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:18px; background:rgba(255,255,255,0.3);}
  .title{ font-size:18px; font-weight:700; margin-left:10px; }
  .header .actions{ margin-left:auto; display:flex; gap:8px; }

  .btn{ background:transparent; border:none; color:inherit; font-size:18px; padding:8px; border-radius:8px; cursor:pointer; }

  /* Messages area */
  .messages{ flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:6px; background:var(--bg); }
  .msg-row{ display:flex; flex-direction:column; }
  .msg{ max-width:75%; padding:10px 12px; border-radius:16px; background:var(--card); box-shadow:0 2px 6px rgba(0,0,0,0.04); position:relative; word-wrap: break-word; }
  .msg.me{ margin-left:auto; background:var(--me); }
  .nick{ font-weight:600; font-size:13px; margin-bottom:4px; color:var(--accent1);}
  .time{ font-size:11px; color:var(--muted); margin-top:4px; text-align:right; }
  audio.msg-audio{ width:180px; margin-top:8px; display:block; }
  img.msg-image{ max-width:180px; border-radius:12px; margin-top:6px; }

  /* Compose area */
  .compose{ display:flex; gap:8px; padding:10px; border-top:1px solid rgba(0,0,0,0.06); background:var(--card); align-items:center; }
  .compose input[type="text"]{ flex:1; padding:10px 14px; border-radius:999px; border:1px solid #dbe5f1; font-size:15px; }
  .compose .compose-btn{ background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:white; border:none; padding:10px 12px; border-radius:999px; font-size:16px; cursor:pointer; }
  .compose .icon-btn{ background:transparent; border:none; font-size:20px; padding:8px; cursor:pointer; }

  /* Recorder */
  .recorder{ display:flex; gap:8px; align-items:center; padding:8px; border-radius:10px; background:rgba(58,123,213,0.1); margin:6px 0; }
  .rec-dot{ width:10px; height:10px; border-radius:50%; background:#d9534f; animation:blink 1s linear infinite; }
  @keyframes blink{ 0%,100%{opacity:1} 50%{opacity:0.1} }

  /* small */
  .small-muted{ font-size:12px; color:var(--muted); }
  .center{text-align:center;}
</style>
</head>
<body>
<div class="app" id="app" data-theme="light">

  <div class="header">
    <div class="logo">A</div>
    <div class="title">AstikMessenger</div>
    <div class="actions">
      <button id="btnTheme" class="btn">ðŸŒ“</button>
      <button id="btnSignIn" class="btn">Ð’Ð¾Ð¹Ñ‚Ð¸</button>
      <button id="btnSignOut" class="btn" style="display:none">â¤«</button>
    </div>
  </div>

  <div style="flex:1; display:flex; flex-direction:column; min-height:0;">
    <div id="messages" class="messages"></div>

    <div id="recorderUI" style="display:none;">
      <div class="recorder">
        <div class="rec-dot"></div>
        <div id="recTime">00:00</div>
        <div style="margin-left:auto; display:flex; gap:8px;">
          <button id="btnCancelRec" class="icon-btn">âœ–</button>
          <button id="btnSendRec" class="compose-btn">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ</button>
        </div>
      </div>
    </div>

    <div class="compose">
      <input id="inputMessage" type="text" placeholder="ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..." autocomplete="off">
      <button id="btnRecord" class="icon-btn" title="Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ">ðŸŽ¤</button>
      <button id="btnSend" class="compose-btn">âž¤</button>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getDatabase, ref, push, onChildAdded, set } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCysKcXFVoqWDIQzkdObB-9sgm54cRGyp0",
  authDomain: "test3-88cee.firebaseapp.com",
  databaseURL: "https://test3-88cee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test3-88cee",
  storageBucket: "test3-88cee.firebasestorage.app",
  messagingSenderId: "469479851370",
  appId: "1:469479851370:web:915e95767b012c281e1113"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const storage = getStorage(app);

/* DOM */
const btnSignIn = document.getElementById("btnSignIn");
const btnSignOut = document.getElementById("btnSignOut");
const btnTheme = document.getElementById("btnTheme");
const messagesEl = document.getElementById("messages");
const btnSend = document.getElementById("btnSend");
const inputMessage = document.getElementById("inputMessage");
const btnRecord = document.getElementById("btnRecord");
const recorderUI = document.getElementById("recorderUI");
const recTimeEl = document.getElementById("recTime");
const btnCancelRec = document.getElementById("btnCancelRec");
const btnSendRec = document.getElementById("btnSendRec");

let currentUser = null;
let localDeviceId = "dev_" + Math.random().toString(36).slice(2,9);
let mediaRecorder = null;
let recordedChunks = [];
let recStartTs = 0;
let recTimer = null;

/* Theme */
let theme = localStorage.getItem("astik:theme") || "light";
document.getElementById("app").setAttribute("data-theme", theme);
btnTheme.addEventListener("click", ()=>{
  theme = (theme==="light")?"dark":"light";
  document.getElementById("app").setAttribute("data-theme", theme);
  localStorage.setItem("astik:theme",theme);
});

/* Auth */
btnSignIn.addEventListener("click", async ()=>{
  const provider = new GoogleAuthProvider();
  await signInWithPopup(auth, provider);
});
btnSignOut.addEventListener("click", ()=>signOut(auth));

onAuthStateChanged(auth, user=>{
  currentUser = user;
  btnSignIn.style.display = user?"none":"inline-block";
  btnSignOut.style.display = user?"inline-block":"none";
});

/* Messages */
function fmtTime(ts){
  const d = new Date(ts||Date.now());
  return d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0');
}
const msgsRef = ref(db, "messages");
onChildAdded(msgsRef, snap=>{
  const msg = snap.val();
  renderMessage(msg);
});

function renderMessage(msg){
  const isMe = (msg.senderId === (currentUser?currentUser.uid:localDeviceId));
  const row = document.createElement("div");
  row.className="msg-row";
  const bubble = document.createElement("div");
  bubble.className="msg"+(isMe?" me":"");
  if(!isMe){ const nick=document.createElement("div"); nick.className="nick"; nick.textContent=msg.name||"User"; bubble.appendChild(nick);}
  if(msg.type==="text"||!msg.type){
    const p=document.createElement("div"); p.textContent=msg.text; bubble.appendChild(p);
  } else if(msg.type==="audio"&&msg.audioUrl){
    const audio=document.createElement("audio"); audio.controls=true; audio.src=msg.audioUrl; audio.className="msg-audio"; bubble.appendChild(audio);
  }
  const t=document.createElement("div"); t.className="time"; t.textContent=fmtTime(msg.time); bubble.appendChild(t);
  row.appendChild(bubble); messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* Send Text */
btnSend.addEventListener("click", sendText);
inputMessage.addEventListener("keydown", e=>{if(e.key==="Enter")sendText();});
async function sendText(){
  const text=inputMessage.value.trim(); if(!text)return;
  await push(msgsRef,{
    senderId: currentUser?currentUser.uid:localDeviceId,
    name: currentUser?currentUser.displayName:"Guest",
    text,
    type:"text",
    time:Date.now()
  });
  inputMessage.value="";
}

/* Voice Messages */
btnRecord.addEventListener("click", startStopRecording);
function startStopRecording(){
  if(!mediaRecorder||mediaRecorder.state==="inactive") startRecording();
  else stopRecording();
}

async function startRecording(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder=new MediaRecorder(stream);
    recordedChunks=[];
    mediaRecorder.ondataavailable=e=>{ if(e.data.size>0) recordedChunks.push(e.data); };
    mediaRecorder.onstop=async ()=>{
      const blob=new Blob(recordedChunks,{type:'audio/webm'});
      showRecorderUI(false);
      await uploadAudio(blob);
      stream.getTracks().forEach(t=>t.stop());
    };
    mediaRecorder.start();
    recStartTs=Date.now(); startRecTimer();
    showRecorderUI(true); btnRecord.textContent="â¹ï¸";
  } catch(e){ alert("ÐÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ñƒ"); }
}

function stopRecording(){ if(mediaRecorder&&mediaRecorder.state==="recording"){ mediaRecorder.stop(); stopRecTimer(); btnRecord.textContent="ðŸŽ¤"; }}

function showRecorderUI(on){ recorderUI.style.display=on?"block":"none"; recTimeEl.textContent="00:00"; }
function startRecTimer(){ recTimer=setInterval(()=>{const diff=Math.floor((Date.now()-recStartTs)/1000); const mm=String(Math.floor(diff/60)).padStart(2,'0'); const ss=String(diff%60).padStart(2,'0'); recTimeEl.textContent=`${mm}:${ss}`; },250); }
function stopRecTimer(){ clearInterval(recTimer); recTimer=null; }

btnCancelRec.addEventListener("click", ()=>{
  if(mediaRecorder&&mediaRecorder.state==="recording"){ mediaRecorder.stop(); recordedChunks=[]; showRecorderUI(false); btnRecord.textContent="ðŸŽ¤"; stopRecTimer();}
});
btnSendRec.addEventListener("click", ()=>{ stopRecording(); });

async function uploadAudio(blob){
  try{
    const path=`audio/${(currentUser?currentUser.uid:localDeviceId)}/${Date.now()}.webm`;
    const sref1=sref(storage,path);
    await uploadBytes(sref1,blob);
    const url=await getDownloadURL(sref1);
    await push(msgsRef,{
      senderId:currentUser?currentUser.uid:localDeviceId,
      name:currentUser?currentUser.displayName:"Guest",
      type:"audio",
      audioUrl:url,
      time:Date.now()
    });
  }catch(e){ alert("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð°ÑƒÐ´Ð¸Ð¾"); }
}
</script>
</body>
</html>
