<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Чатик</title>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#000;color:#fff;font-family:system-ui,sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden}
  .screen{display:none;height:100%;flex-direction:column}
  .active{display:flex!important}
  
  /* Экран выбора имени */
  #welcome{background:linear-gradient(135deg,#667eea,#764ba2);justify-content:center;align-items:center;text-align:center;padding:20px}
  #welcome h1{font-size:32px;margin-bottom:30px}
  #welcome input{width:90%;max-width:340px;padding:18px;font-size:18px;border:none;border-radius:20px;text-align:center;margin-bottom:20px}
  #welcome button{padding:18px 40px;background:#fff;color:#667eea;font-weight:bold;border-radius:20px;font-size:18px;border:none;cursor:pointer}

  /* Основной интерфейс */
  .chat{flex:1;display:flex;flex-direction:column;background:#111}
  header{padding:16px;background:#000;text-align:center;font-weight:600;font-size:18px;position:relative}
  .back{position:absolute;left:12px;top:12px;font-size:28px;background:none;border:none;color:#fff;cursor:pointer}
  #messages{flex:1;overflow-y:auto;padding:12px 10px;display:flex;flex-direction:column;gap:10px}
  .msg{max-width:82%;padding:11px 15px;border-radius:20px;word-wrap:break-word;align-self:flex-start;background:#222}
  .my{align-self:flex-end;background:#0d8bff;border-bottom-right-radius:5px}
  .name{font-size:13px;font-weight:600;margin-bottom:4px;cursor:pointer;color:#7c9eff}
  .input-area{padding:10px;background:#000;display:flex;gap:10px}
  input{flex:1;padding:15px 18px;background:#222;color:#fff;border:none;border-radius:30px;font-size:17px}
  button.send{width:52px;height:52px;background:#0d8bff;border:none;border-radius:50%;font-size:24px}
</style>
</head>
<body>

<!-- Экран выбора имени -->
<div id="welcome" class="screen active">
  <h1>Привет!</h1>
  <p style="font-size:18px;margin-bottom:30px">Как тебя зовут?</p>
  <input type="text" id="nameInput" placeholder="Введи имя" maxlength="20">
  <button onclick="enterChat()">Войти в чат</button>
</div>

<!-- Главный экран с двумя чатами -->
<div id="main" class="screen">
  <!-- Общий чат -->
  <div class="chat">
    <header>Общий чат</header>
    <div id="messages"></div>
    <div class="input-area">
      <input type="text" id="public-input" placeholder="Сообщение всем...">
      <button class="send" id="public-send">Send</button>
    </div>
  </div>

  <!-- Личный чат -->
  <div class="chat" style="border-top:4px solid #222">
    <header id="private-header">Личный чат — нажми на имя выше ↑</header>
    <div id="private-messages"></div>
    <div class="input-area">
      <input type="text" id="private-input" placeholder="Выбери человека..." disabled>
      <button class="send" id="private-send" disabled>Send</button>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCysKcXFVoqWDIQzkdObB-9sgm54cRGyp0",
  authDomain: "test3-88cee.firebaseapp.com",
  databaseURL: "https://test3-88cee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test3-88cee",
  storageBucket: "test3-88cee.firebasestorage.app",
  messagingSenderId: "469479851370",
  appId: "1:469479851370:web:915e95767b012c281e1113"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let myName = '';
let currentFriend = null;

// Вход по имени
function enterChat() {
  myName = document.getElementById('nameInput').value.trim() || 'Гость';
  if (myName.length < 1) return alert('Введи имя!');
  localStorage.setItem('myName', myName);
  
  document.getElementById('welcome').classList.remove('active');
  document.getElementById('main').classList.add('active');
  
  loadPublicChat();
}

// === Общий чат ===
function loadPublicChat() {
  const ref = db.ref('public_messages');
  ref.orderByChild('time').limitToLast(200).on('child_added', s => {
    const msg = s.val();
    const div = document.createElement('div');
    div.className = `msg ${msg.name === myName ? 'my' : ''}`;
    
    const nameSpan = document.createElement('div');
    nameSpan.className = 'name';
    nameSpan.textContent = msg.name;
    if (msg.name !== myName) {
      nameSpan.onclick = () => openPrivate(msg.name);
    }
    
    const text = document.createElement('div');
    text.textContent = msg.text;
    
    div.appendChild(nameSpan);
    div.appendChild(text);
    document.getElementById('messages').appendChild(div);
    div.scrollIntoView({behavior: 'smooth'});
  });
}

// Отправка в общий
document.getElementById('public-send').onclick = () => sendMsg('public_messages', 'public-input');
document.getElementById('public-input').onkeypress = e => { if(e.key==='Enter') sendMsg('public_messages', 'public-input'); };

// === Личный чат ===
function openPrivate(friendName) {
  if (friendName === myName) return;
  currentFriend = friendName;
  document.getElementById('private-header').textContent = `Чат с ${friendName}`;
  document.getElementById('private-input').disabled = false;
  document.getElementById('private-send').disabled = false;
  document.getElementById('private-input').placeholder = `Пиши ${friendName}...`;
  document.getElementById('private-messages').innerHTML = '';

  const chatId = [myName, friendName].sort().join('_').toLowerCase();
  const ref = db.ref(`private_chats/${chatId}/messages`);
  
  ref.orderByChild('time').limitToLast(200).on('child_added', s => {
    const msg = s.val();
    const div = document.createElement('div');
    div.className = `msg ${msg.name === myName ? 'my' : ''}`;
    div.innerHTML = `<div class="name">${msg.name === myName ? 'Вы' : friendName}</div><div>${msg.text}</div>`;
    document.getElementById('private-messages').appendChild(div);
    div.scrollIntoView({behavior: 'smooth'});
  });

  // Отправка в личку
  const sendPrivate = () => sendMsg(`private_chats/${chatId}/messages`, 'private-input');
  document.getElementById('private-send').onclick = sendPrivate;
  document.getElementById('private-input').onkeypress = e => { if(e.key==='Enter') sendPrivate(); };
}

function sendMsg(path, inputId) {
  const input = document.getElementById(inputId);
  const text = input.value.trim();
  if (!text) return;
  db.ref(path).push({name: myName, text: text, time: Date.now()});
  input.value = '';
}

// Автозагрузка имени
window.onload = () => {
  const saved = localStorage.getItem('myName');
  if (saved) {
    myName = saved;
    document.getElementById('nameInput').value = saved;
    enterChat();
  }
}
</script>
</body>
</html>
