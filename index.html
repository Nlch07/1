<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Чат 2-в-1</title>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#000;color:#fff;font-family:system-ui,sans-serif;display:flex;height:100vh;overflow:hidden}
  .chat{width:100%;display:flex;flex-direction:column;border-right:4px solid #111}
  .chat:last-child{border-right:none}
  header{padding:16px;background:#111;text-align:center;font-size:18px}
  #messages, #private-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
  .msg{max-width:80%;padding:12px 16px;border-radius:18px;align-self:flex-start;background:#222}
  .my{align-self:flex-end;background:#0d8bff;border-bottom-right-radius:4px}
  .name{font-size:13px;font-weight:600;margin-bottom:4px}
  .input-area{padding:10px;background:#111;display:flex;gap:10px}
  input{flex:1;padding:14px 18px;background:#222;color:#fff;border:none;border-radius:30px;font-size:17px}
  button{width:50px;height:50px;background:#0d8bff;border:none;border-radius:50%;font-size:22px}
  @media(min-width:768px){.container{display:flex} .chat{width:50%}}
</style>
</head>
<body>

<div class="container">
  <!-- Общий чат -->
  <div class="chat" id="public-chat">
    <header>Общий чат</header>
    <div id="messages"></div>
    <div class="input-area">
      <input type="text" id="public-input" placeholder="Сообщение в общий...">
      <button id="public-send">Send</button>
    </div>
  </div>

  <!-- Личный чат (один на всех, но с выбранным человеком) -->
  <div class="chat" id="private-chat">
    <header id="private-header">Личный чат — выбери человека</header>
    <div id="private-messages"></div>
    <div class="input-area">
      <input type="text" id="private-input" placeholder="Напиши ему..." disabled>
      <button id="private-send" disabled>Send</button>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCysKcXFVoqWDIQzkdObB-9sgm54cRGyp0",
  authDomain: "test3-88cee.firebaseapp.com",
  databaseURL: "https://test3-88cee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test3-88cee",
  storageBucket: "test3-88cee.firebasestorage.app",
  messagingSenderId: "469479851370",
  appId: "1:469479851370:web:915e95767b012c281e1113"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let myName = localStorage.getItem('myName') || prompt('Введи своё имя', 'Гость') || 'Гость';
localStorage.setItem('myName', myName);

let currentFriend = null;

// === ОБЩИЙ ЧАТ ===
const publicRef = db.ref('public_messages');
publicRef.orderByChild('time').limitToLast(200).on('child_added', s => addMsg(s.val(), 'messages', true));

document.getElementById('public-send').onclick = () => send('public_messages', 'public-input');
document.getElementById('public-input').onkeypress = e => { if(e.key==='Enter') send('public_messages', 'public-input'); };

// === ЛИЧНЫЙ ЧАТ ===
function startPrivateWith(name){
  if(name === myName){ alert('Это ты сам'); return; }
  currentFriend = name;
  document.getElementById('private-header').textContent = `Чат с ${name}`;
  document.getElementById('private-input').disabled = false;
  document.getElementById('private-send').disabled = false;
  document.getElementById('private-messages').innerHTML = '';

  const chatId = [myName, name].sort().join('_');
  const ref = db.ref(`private_chats/${chatId}/messages`);
  ref.orderByChild('time').limitToLast(200).on('child_added', s => addMsg(s.val(), 'private-messages', false));
  
  document.getElementById('private-send').onclick = () => send(`private_chats/${chatId}/messages`, 'private-input');
  document.getElementById('private-input').onkeypress = e => { if(e.key==='Enter') send(`private_chats/${chatId}/messages`, 'private-input'); };
}

// Добавление сообщения
function addMsg(msg, containerId, isPublic){
  const div = document.createElement('div');
  div.className = `msg ${msg.name===myName ? 'my' : ''}`;
  div.innerHTML = `
    <div class="name" ${isPublic && msg.name!==myName ? `style="cursor:pointer" onclick="startPrivateWith('${msg.name}')"` : ''}>
      ${msg.name===myName ? 'Вы' : msg.name}
    </div>
    <div>${msg.text}</div>`;
  document.getElementById(containerId).appendChild(div);
  div.scrollIntoView({behavior:'smooth', block:'nearest'});
}

// Отправка
function send(path, inputId){
  const text = document.getElementById(inputId).value.trim();
  if(!text) return;
  db.ref(path).push({name:myName, text, time:Date.now()});
  document.getElementById(inputId).value = '';
}
</script>
</body>
</html>
