<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AstikChat</title>
  <meta name="theme-color" content="#128c7e">
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      background:#000;color:#fff;font-family:-apple-system,system-ui,sans-serif;
      height:100dvh;display:flex;align-items:flex-end;justify-content:center;
      padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      overflow:hidden;
    }
    #app{
      width:100%;max-width:480px;height:100dvh;
      background:#0b141a;border-radius:28px 28px 0 0;
      overflow:hidden;box-shadow:0 -20px 80px rgba(0,0,0,0.9);
      position:relative;display:flex;flex-direction:column;
    }
    #app::before{
      content:'';position:absolute;top:10px;left:50%;transform:translateX(-50%);
      width:140px;height:5px;background:#333;border-radius:10px;z-index:10;
    }

    header{
      background:#128c7e;padding:14px 18px;color:white;
      font-size:22px;font-weight:700;text-align:center;position:relative;z-index:5;
      display:flex;align-items:center;justify-content:center;
    }
    header .title {flex:1;text-align:center;margin-left:-50px;}
    .header-btn{
      width:46px;height:46px;border-radius:50%;background:rgba(255,255,255,0.15);
      display:flex;align-items:center;justify-content:center;font-size:22px;
      cursor:pointer;transition:0.2s;
    }
    .header-btn:active{transform:scale(0.9);background:rgba(255,255,255,0.3)}

    #main{display:none;flex-direction:column;height:100%}
    #chat-list{flex:1;overflow-y:auto;background:#11141a;padding:8px 0}
    .chat-item{
      padding:14px 18px;display:flex;align-items:center;gap:16px;
      cursor:pointer;transition:0.15s;position:relative;
    }
    .chat-item:active{background:#1a242e}
    .avatar{
      width:58px;height:58px;border-radius:50%;background:#25d366;color:#000;
      display:flex;align-items:center;justify-content:center;
      font-weight:bold;font-size:24px;flex-shrink:0;
    }
    .info{flex:1;min-width:0}
    .chat-name{font-size:18px;font-weight:500}
    .last-msg{font-size:14.8px;color:#b0b7c0;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .unread{
      background:#25d366;color:#000;padding:4px 9px;border-radius:12px;
      font-size:12px;font-weight:bold;min-width:20px;text-align:center;
    }

    #chat-screen{display:none;flex-direction:column;height:100%}
    #chat-header{
      background:#128c7e;padding:14px 18px;display:flex;align-items:center;gap:16px;position:relative;
    }
    .back-btn{
      position:absolute;left:14px;top:12px;background:none;border:none;color:white;
      font-size:30px;cursor:pointer;
    }
    #chat-messages{
      flex:1;overflow-y:auto;background:#0b141a;padding:12px 10px;
      display:flex;flex-direction:column;gap:10px;
    }
    .message{
      max-width:78%;padding:9px 14px;border-radius:18px;line-height:1.45;
      word-wrap:break-word;position:relative;
    }
    .sent{
      align-self:flex-end;background:#005c4b;color:white;
      border-bottom-right-radius:4px;
    }
    .received{
      align-self:flex-start;background:#262d31;color:white;
      border-bottom-left-radius:4px;
    }
    .msg-text{margin-bottom:4px}
    .msg-time{font-size:11.5px;opacity:0.7;text-align:right}

    .input-bar{
      background:#11141a;padding:10px 14px;display:flex;align-items:center;gap:12px;
    }
    #msg-input{
      flex:1;padding:14px 18px;background:#2a3942;border:none;border-radius:30px;
      color:white;font-size:16.5px;outline:none;
    }
    #send-btn{
      width:50px;height:50px;background:#25d366;border:none;border-radius:50%;
      color:#000;font-size:26px;font-weight:bold;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
    }

    #welcome{
      position:absolute;inset:0;background:linear-gradient(135deg,#128c7e,#25d366);
      display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:100;
    }
    #welcome h1{font-size:44px;margin-bottom:16px}
    #welcome input{
      width:88%;padding:20px;border:none;border-radius:20px;font-size:19px;
      text-align:center;margin:20px 0;outline:none;
    }
    #welcome button{
      padding:18px 80px;background:white;color:#128c7e;border-radius:40px;
      font-size:20px;font-weight:bold;border:none;cursor:pointer;
    }
  </style>
</head>
<body>

<div id="app">
  <!-- Приветствие -->
  <div id="welcome">
    <h1>AstikChat</h1>
    <p style="font-size:20px;margin-bottom:30px">Введи своё имя</p>
    <input type="text" id="nameInput" placeholder="Твой ник" maxlength="18">
    <button onclick="start()">Войти</button>
  </div>

  <!-- Главный экран -->
  <div id="main">
    <header>
      <div class="header-btn" onclick="newPrivate()">Plus</div>
      <div class="title">AstikChat</div>
      <div class="header-btn" onclick="changeName()">Edit</div>
      <div class="header-btn" onclick="toggleTheme()" id="themeBtn">Moon</div>
    </header>

    <div id="chat-list">
      <div class="chat-item" onclick="openPublic()">
        <div class="avatar">G</div>
        <div class="info">
          <div class="chat-name">Общий чат</div>
          <div class="last-msg">Все пишут сюда</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Чат -->
  <div id="chat-screen">
    <div id="chat-header">
      <button class="back-btn" onclick="back()">Back</button>
      <div class="avatar" id="partner-avatar">A</div>
      <div class="info">
        <div class="chat-name" id="partner-name">Чат</div>
      </div>
    </div>
    <div id="chat-messages"></div>
    <div class="input-bar">
      <input type="text" id="msg-input" placeholder="Сообщение...">
      <button id="send-btn" onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCysKcXFVoqWDIQzkdObB-9sgm54cRGyp0",
  authDomain: "test3-88cee.firebaseapp.com",
  databaseURL: "https://test3-88cee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test3-88cee",
  storageBucket: "test3-88cee.appspot.com",
  messagingSenderId: "469479851370",
  appId: "1:469479851370:web:915e95767b012c281e1113"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let myName = localStorage.getItem('astik_name') || '';
let currentChatId = null;
let currentPartner = null;

// Тема
const savedTheme = localStorage.getItem('astik_theme') || 'dark';
if (savedTheme === 'light') document.body.classList.add('light');
document.getElementById('themeBtn').textContent = savedTheme === 'light' ? 'Sun' : 'Moon';

function toggleTheme() {
  document.body.classList.toggle('light');
  const isLight = document.body.classList.contains('light');
  localStorage.setItem('astik_theme', isLight ? 'light' : 'dark');
  document.getElementById('themeBtn').textContent = isLight ? 'Sun' : 'Moon';
}

if (myName) start();

function start() {
  if (!myName) {
    myName = (document.getElementById('nameInput').value || 'Гость').trim();
    if (!myName) return alert('Введите имя!');
    localStorage.setItem('astik_name', myName);
  }
  document.getElementById('welcome').remove();
  document.getElementById('main').style.display = 'flex';
  loadChats();
}

function changeName() {
  const n = prompt('Новое имя:', myName);
  if (n && n.trim() && n.trim() !== myName) {
    myName = n.trim();
    localStorage.setItem('astik_name', myName);
    loadChats();
  }
}

function chatId(a, b) {
  return [a.toLowerCase(), b.toLowerCase()].sort().join('_');
}

function newPrivate() {
  const nick = prompt('С кем начать чат?\nВведите ник:').trim();
  if (!nick || nick.toLowerCase() === myName.toLowerCase()) return alert('Некорректный ник');
  openChat(nick);
}

function openPublic() {
  currentChatId = 'public';
  currentPartner = null;
  showChatScreen('Общий чат', 'G');
  listenToMessages('public_messages');
}

function openChat(partner) {
  currentChatId = chatId(myName, partner);
  currentPartner = partner;
  showChatScreen(partner, partner[0].toUpperCase());
  listenToMessages(`private_chats/${currentChatId}/messages`);
}

function showChatScreen(title, avatar) {
  document.getElementById('main').style.display = 'none';
  document.getElementById('chat-screen').style.display = 'flex';
  document.getElementById('partner-name').textContent = title;
  document.getElementById('partner-avatar').textContent = avatar;
  document.getElementById('chat-messages').innerHTML = '';
}

function listenToMessages(path) {
  db.ref(path).limitToLast(200).on('child_added', s => {
    const m = s.val();
    const isMe = m.name === myName;
    const div = document.createElement('div');
    div.className = `message ${isMe ? 'sent' : 'received'}`;
    div.innerHTML = `
      <div class="msg-text">${m.text}</div>
      <div class="msg-time">${new Date(m.time).toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'})}</div>
    `;
    document.getElementById('chat-messages').appendChild(div);
    div.scrollIntoView({behavior:'smooth'});
  });
}

function sendMessage() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text) return;

  const msg = { name: myName, text, time: Date.now() };

  if (currentChatId === 'public') {
    db.ref('public_messages').push(msg);
  } else {
    const path = `private_chats/${currentChatId}/messages`;
    db.ref(path).push(msg);
    db.ref(`private_chats/${currentChatId}`).update({
      lastMsg: text.substring(0,40)+(text.length>40?'...':''),
      lastTime: Date.now()
    });
  }
  input.value = '';
}

function back() {
  document.getElementById('chat-screen').style.display = 'none';
  document.getElementById('main').style.display = 'flex';
  loadChats();
}

function loadChats() {
  const container = document.getElementById('chat-list');
  container.innerHTML = `<div class="chat-item" onclick="openPublic()">
    <div class="avatar">G</div>
    <div class="info">
      <div class="chat-name">Общий чат</div>
      <div class="last-msg">Все пишут сюда</div>
    </div>
  </div>`;

  db.ref('private_chats').orderByChild('lastTime').on('value', snap => {
    container.querySelectorAll('.private').forEach(el => el.remove());
    snap.forEach(child => {
      const data = child.val();
      const id = child.key;
      const partner = id.split('_').find(u => u.toLowerCase() !== myName.toLowerCase());
      if (partner && data.lastMsg) {
        const item = document.createElement('div');
        item.className = 'chat-item private';
        item.onclick = () => openChat(partner);
        item.innerHTML = `
          <div class="avatar">${partner[0].toUpperCase()}</div>
          <div class="info">
            <div class="chat-name">${partner}</div>
            <div class="last-msg">${data.lastMsg}</div>
          </div>
        `;
        container.appendChild(item);
      }
    });
  });
}

document.getElementById('send-btn').onclick = sendMessage;
document.getElementById('msg-input').addEventListener('keypress', e => {
  if (e.key === 'Enter') sendMessage();
});
</script>
</body>
</html>
