<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Astik Messenger</title>
<style>
:root {
  --primary: #7C3AED;
  --primary-light: #8B5CF6;
  --secondary: #10B981;
  --bg: #0F172A;
  --surface: #1E293B;
  --surface-light: #334155;
  --text: #F1F5F9;
  --text-light: #94A3B8;
  --border: #475569;
  --online: #10B981;
  --typing: #F59E0B;
  --my-msg: #7C3AED;
  --other-msg: #334155;
  --danger: #EF4444;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 0;
}

.app {
  width: 100%;
  max-width: 100%;
  height: 100vh;
  background: var(--surface);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Header */
.header {
  padding: 16px;
  background: var(--surface-light);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.app-title {
  font-size: 20px;
  font-weight: 700;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.user-badge {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--surface);
  padding: 6px 12px;
  border-radius: 20px;
}

.user-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 12px;
}

/* Tabs */
.tabs {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  background: var(--surface-light);
  padding: 4px;
  gap: 4px;
}

.tab {
  padding: 12px;
  border: none;
  background: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-light);
  cursor: pointer;
  transition: all 0.2s;
}

.tab.active {
  background: var(--surface);
  color: var(--text);
  font-weight: 600;
}

/* Online Status */
.online-status {
  padding: 12px 16px;
  background: rgba(16, 185, 129, 0.1);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--online);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Lists */
.list-container {
  flex: 1;
  overflow-y: auto;
  display: none;
}

.list-container.active {
  display: block;
}

.list-item {
  display: flex;
  align-items: center;
  padding: 16px;
  gap: 12px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.2s;
}

.list-item:hover {
  background: var(--surface-light);
}

.user-avatar.medium {
  width: 44px;
  height: 44px;
  font-size: 16px;
}

.user-info {
  flex: 1;
}

.user-name {
  font-weight: 600;
  font-size: 16px;
  margin-bottom: 4px;
}

.user-details {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--text-light);
}

.typing-indicator {
  color: var(--typing);
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.typing-dots {
  display: flex;
  gap: 2px;
}

.typing-dot {
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--typing);
  animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-4px); }
}

/* Chat Container */
.chat-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  display: none;
}

.chat-container.active {
  display: flex;
}

.chat-header {
  padding: 16px;
  background: var(--surface-light);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
}

.back-btn {
  background: none;
  border: none;
  color: var(--text);
  font-size: 20px;
  cursor: pointer;
}

.chat-info {
  flex: 1;
}

.chat-title {
  font-weight: 600;
  font-size: 16px;
  margin-bottom: 4px;
}

.chat-status {
  font-size: 12px;
  color: var(--text-light);
  display: flex;
  align-items: center;
  gap: 6px;
}

/* Messages */
.messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  background: var(--bg);
}

.message {
  max-width: 85%;
  padding: 12px 16px;
  border-radius: 18px;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message.sent {
  align-self: flex-end;
  background: var(--my-msg);
  border-bottom-right-radius: 4px;
}

.message.received {
  align-self: flex-start;
  background: var(--other-msg);
  border-bottom-left-radius: 4px;
}

.message-sender {
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--primary-light);
}

.message-time {
  font-size: 11px;
  opacity: 0.7;
  text-align: right;
  margin-top: 4px;
}

/* Input */
.input-area {
  padding: 16px;
  background: var(--surface);
  border-top: 1px solid var(--border);
  display: flex;
  gap: 12px;
  align-items: center;
}

.message-input {
  flex: 1;
  padding: 12px 16px;
  background: var(--surface-light);
  border: 2px solid var(--border);
  border-radius: 24px;
  color: var(--text);
  font-size: 15px;
  outline: none;
}

.message-input:focus {
  border-color: var(--primary);
}

.send-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--primary);
  border: none;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.send-btn:active {
  transform: scale(0.95);
}

/* Empty States */
.empty-state {
  text-align: center;
  padding: 48px 24px;
  color: var(--text-light);
}

/* Settings */
.settings-panel {
  position: fixed;
  top: 0;
  right: -100%;
  width: 300px;
  height: 100%;
  background: var(--surface);
  border-left: 1px solid var(--border);
  padding: 24px;
  transition: right 0.3s;
  z-index: 1000;
}

.settings-panel.active {
  right: 0;
}

.settings-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
}

.settings-title {
  font-size: 18px;
  font-weight: 600;
}

.close-btn {
  background: none;
  border: none;
  color: var(--text);
  font-size: 20px;
  cursor: pointer;
}

.setting-item {
  margin-bottom: 20px;
}

.setting-label {
  display: block;
  margin-bottom: 8px;
  color: var(--text-light);
  font-size: 14px;
}

.setting-input {
  width: 100%;
  padding: 12px;
  background: var(--surface-light);
  border: 2px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-size: 14px;
}

.save-btn {
  width: 100%;
  padding: 14px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 24px;
}

/* Overlay */
.overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  z-index: 999;
}

.overlay.active {
  display: block;
}
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <div class="header">
    <div class="app-title">Astik Messenger</div>
    <div class="user-badge" id="userBadge">
      <div class="user-avatar" id="headerAvatar">?</div>
      <span id="headerUsername">Вход...</span>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="online">Онлайн</button>
    <button class="tab" data-tab="chats">Чаты</button>
    <button class="tab" data-tab="general">Общий</button>
  </div>

  <!-- Online Status -->
  <div class="online-status">
    <div class="status-dot"></div>
    <span id="onlineCount">Загрузка...</span>
  </div>

  <!-- Online Users -->
  <div class="list-container active" id="onlineContainer">
    <!-- Users will appear here -->
  </div>

  <!-- Chats -->
  <div class="list-container" id="chatsContainer">
    <div class="empty-state">
      <p>У вас пока нет личных чатов</p>
      <p style="font-size: 13px; margin-top: 8px;">Начните общение с пользователя из списка "Онлайн"</p>
    </div>
  </div>

  <!-- General Chat -->
  <div class="chat-container" id="generalChat">
    <div class="chat-header">
      <button class="back-btn" data-back="tabs">←</button>
      <div class="chat-info">
        <div class="chat-title">Общий чат</div>
        <div class="chat-status" id="generalStatus">Все участники</div>
      </div>
    </div>
    
    <div class="messages-container" id="generalMessages">
      <!-- Messages will appear here -->
    </div>
    
    <div class="input-area">
      <input type="text" class="message-input" id="generalInput" placeholder="Сообщение для всех...">
      <button class="send-btn" id="sendGeneralBtn">➤</button>
    </div>
  </div>

  <!-- Private Chat -->
  <div class="chat-container" id="privateChat">
    <div class="chat-header">
      <button class="back-btn" data-back="chats">←</button>
      <div class="chat-info">
        <div class="chat-title" id="privateChatTitle">...</div>
        <div class="chat-status" id="privateChatStatus">
          <span id="privateStatusText">Онлайн</span>
          <span class="typing-indicator" id="privateTypingIndicator" style="display: none;">
            <span>печатает</span>
            <div class="typing-dots">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </span>
        </div>
      </div>
    </div>
    
    <div class="messages-container" id="privateMessages">
      <!-- Private messages will appear here -->
    </div>
    
    <div class="input-area">
      <input type="text" class="message-input" id="privateInput" placeholder="Личное сообщение...">
      <button class="send-btn" id="sendPrivateBtn">➤</button>
    </div>
  </div>
</div>

<!-- Settings Panel -->
<div class="overlay" id="overlay"></div>
<div class="settings-panel" id="settingsPanel">
  <div class="settings-header">
    <div class="settings-title">Настройки</div>
    <button class="close-btn" id="closeSettingsBtn">×</button>
  </div>
  
  <div class="setting-item">
    <label class="setting-label">Ваш никнейм</label>
    <input type="text" class="setting-input" id="nicknameInput" maxlength="20">
    <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">Будет виден другим пользователям</div>
  </div>
  
  <button class="save-btn" id="saveSettingsBtn">Сохранить</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, push, onChildAdded, onValue, remove, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCysKcXFVoqWDIQzkdObB-9sgm54cRGyp0",
  authDomain: "test3-88cee.firebaseapp.com",
  databaseURL: "https://test3-88cee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test3-88cee",
  storageBucket: "test3-88cee.appspot.com",
  messagingSenderId: "469479851370",
  appId: "1:469479851370:web:915e95767b012c281e1113"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// DOM Elements
const tabs = document.querySelectorAll('.tab');
const containers = {
  online: document.getElementById('onlineContainer'),
  chats: document.getElementById('chatsContainer'),
  general: document.getElementById('generalChat')
};

const chatContainers = {
  general: document.getElementById('generalChat'),
  private: document.getElementById('privateChat')
};

const userBadge = document.getElementById('userBadge');
const headerAvatar = document.getElementById('headerAvatar');
const headerUsername = document.getElementById('headerUsername');
const onlineCount = document.getElementById('onlineCount');

// Inputs and buttons
const generalInput = document.getElementById('generalInput');
const privateInput = document.getElementById('privateInput');
const sendGeneralBtn = document.getElementById('sendGeneralBtn');
const sendPrivateBtn = document.getElementById('sendPrivateBtn');

// Settings
const settingsPanel = document.getElementById('settingsPanel');
const overlay = document.getElementById('overlay');
const nicknameInput = document.getElementById('nicknameInput');
const saveSettingsBtn = document.getElementById('saveSettingsBtn');
const closeSettingsBtn = document.getElementById('closeSettingsBtn');

// User state
let currentUser = {
  id: null,
  name: null,
  isOnline: false
};

let onlineUsers = {};
let typingUsers = {};
let currentChatWith = null;
let userTypingTimeout = null;

// Check saved nickname on load
window.addEventListener('load', () => {
  const savedNickname = localStorage.getItem('astik_nickname');
  if (savedNickname) {
    // Auto-login with saved nickname
    loginUser(savedNickname);
  } else {
    // Show settings to set nickname
    setTimeout(() => openSettings(), 500);
  }
});

// Open settings when clicking user badge
userBadge.addEventListener('click', openSettings);

function openSettings() {
  const currentNickname = localStorage.getItem('astik_nickname') || '';
  nicknameInput.value = currentNickname;
  settingsPanel.classList.add('active');
  overlay.classList.add('active');
}

function closeSettings() {
  settingsPanel.classList.remove('active');
  overlay.classList.remove('active');
}

closeSettingsBtn.addEventListener('click', closeSettings);
overlay.addEventListener('click', closeSettings);

saveSettingsBtn.addEventListener('click', () => {
  const nickname = nicknameInput.value.trim();
  if (!nickname) {
    alert('Введите никнейм');
    return;
  }
  
  localStorage.setItem('astik_nickname', nickname);
  
  if (currentUser.id) {
    // Update existing user
    updateUserNickname(nickname);
  } else {
    // Login new user
    loginUser(nickname);
  }
  
  closeSettings();
});

function loginUser(nickname) {
  currentUser.id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  currentUser.name = nickname;
  currentUser.isOnline = true;

  // Update header
  headerAvatar.textContent = nickname.charAt(0).toUpperCase();
  headerUsername.textContent = nickname;

  // Save user to database
  const userRef = ref(db, `users/${currentUser.id}`);
  set(userRef, {
    name: nickname,
    isOnline: true,
    lastSeen: Date.now(),
    avatarColor: getRandomColor()
  });

  // Start listening
  startListening();
}

function updateUserNickname(nickname) {
  currentUser.name = nickname;
  
  // Update header
  headerAvatar.textContent = nickname.charAt(0).toUpperCase();
  headerUsername.textContent = nickname;
  
  // Update in database
  const userRef = ref(db, `users/${currentUser.id}`);
  set(userRef, {
    name: nickname,
    isOnline: true,
    lastSeen: Date.now(),
    avatarColor: getRandomColor()
  });
}

function getRandomColor() {
  const colors = ['#7C3AED', '#10B981', '#F59E0B', '#EF4444', '#3B82F6'];
  return colors[Math.floor(Math.random() * colors.length)];
}

function startListening() {
  loadOnlineUsers();
  loadGeneralMessages();
  setupTypingListener();
  setupPresence();
}

// Tab switching
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    const tabName = tab.dataset.tab;
    
    // Update tabs
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    
    // Hide all containers
    Object.values(containers).forEach(container => {
      container.classList.remove('active');
    });
    
    // Show selected container
    if (tabName === 'general') {
      // For general tab, show chat directly
      containers.online.classList.remove('active');
      containers.chats.classList.remove('active');
      chatContainers.general.classList.add('active');
    } else {
      // For other tabs, show list
      containers[tabName].classList.add('active');
      chatContainers.general.classList.remove('active');
      chatContainers.private.classList.remove('active');
    }
  });
});

// Back buttons
document.querySelectorAll('.back-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const backTo = btn.dataset.back;
    
    if (backTo === 'tabs') {
      // Back to tabs from general chat
      chatContainers.general.classList.remove('active');
      containers.online.classList.add('active');
      tabs.forEach(t => t.classList.remove('active'));
      document.querySelector('[data-tab="online"]').classList.add('active');
    } else if (backTo === 'chats') {
      // Back to chats from private chat
      chatContainers.private.classList.remove('active');
      containers.chats.classList.add('active');
      tabs.forEach(t => t.classList.remove('active'));
      document.querySelector('[data-tab="chats"]').classList.add('active');
      currentChatWith = null;
    }
  });
});

// Load online users
function loadOnlineUsers() {
  const usersRef = ref(db, 'users');
  const onlineContainer = document.getElementById('onlineContainer');
  
  onValue(usersRef, (snapshot) => {
    const users = snapshot.val();
    onlineUsers = users || {};
    
    // Update online count
    const onlineUsersCount = Object.values(onlineUsers).filter(user => user.isOnline).length;
    onlineCount.textContent = `${onlineUsersCount} пользователей онлайн`;
    
    // Clear and rebuild list
    onlineContainer.innerHTML = '';
    
    // Add current user first
    if (currentUser.id && onlineUsers[currentUser.id]) {
      addUserToList(currentUser.id, onlineUsers[currentUser.id], onlineContainer, true);
    }
    
    // Add other users
    Object.entries(onlineUsers).forEach(([userId, userData]) => {
      if (userId !== currentUser.id) {
        addUserToList(userId, userData, onlineContainer, false);
      }
    });
    
    // Update chats list
    updateChatsList();
  });
}

function addUserToList(userId, userData, container, isCurrentUser) {
  const userItem = document.createElement('div');
  userItem.className = 'list-item';
  userItem.dataset.userId = userId;
  
  const avatarLetter = userData.name ? userData.name.charAt(0).toUpperCase() : '?';
  const isOnline = userData.isOnline;
  const statusText = isOnline ? 'Онлайн' : 'Был(а) ' + formatTime(userData.lastSeen);
  
  userItem.innerHTML = `
    <div class="user-avatar medium" style="background: ${userData.avatarColor || getRandomColor()};">${avatarLetter}</div>
    <div class="user-info">
      <div class="user-name">${userData.name} ${isCurrentUser ? '(Вы)' : ''}</div>
      <div class="user-details">
        ${isOnline ? '<div class="status-dot"></div>' : ''}
        <span>${statusText}</span>
        ${typingUsers[userId] ? `
          <span class="typing-indicator">
            печатает
            <div class="typing-dots">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </span>
        ` : ''}
      </div>
    </div>
  `;
  
  if (!isCurrentUser) {
    userItem.addEventListener('click', () => {
      startPrivateChat(userId, userData.name, userData.avatarColor);
    });
  }
  
  container.appendChild(userItem);
}

function formatTime(timestamp) {
  const now = Date.now();
  const diff = now - timestamp;
  const minutes = Math.floor(diff / 60000);
  
  if (minutes < 1) return 'только что';
  if (minutes < 60) return `${minutes} мин назад`;
  
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours} ч назад`;
  
  const days = Math.floor(hours / 24);
  return `${days} дн назад`;
}

function updateChatsList() {
  const chatsContainer = document.getElementById('chatsContainer');
  const hasChats = Object.keys(onlineUsers).length > 1;
  
  if (!hasChats) {
    chatsContainer.innerHTML = `
      <div class="empty-state">
        <p>У вас пока нет личных чатов</p>
        <p style="font-size: 13px; margin-top: 8px;">Начните общение с пользователя из списка "Онлайн"</p>
      </div>
    `;
    return;
  }
}

function startPrivateChat(userId, userName, avatarColor) {
  currentChatWith = userId;
  
  // Update chat header
  document.getElementById('privateChatTitle').textContent = userName;
  document.getElementById('privateStatusText').textContent = onlineUsers[userId]?.isOnline ? 'Онлайн' : 'Оффлайн';
  
  // Load messages
  loadPrivateMessages(userId);
  
  // Switch to private chat
  containers.online.classList.remove('active');
  containers.chats.classList.remove('active');
  chatContainers.general.classList.remove('active');
  chatContainers.private.classList.add('active');
}

// Load general messages
function loadGeneralMessages() {
  const messagesRef = ref(db, 'messages/general');
  const container = document.getElementById('generalMessages');
  container.innerHTML = '';
  
  onChildAdded(messagesRef, (snapshot) => {
    const message = snapshot.val();
    if (message) {
      addMessageToContainer(message, container, 'general');
    }
  });
}

// Load private messages
function loadPrivateMessages(userId) {
  const chatId = [currentUser.id, userId].sort().join('_');
  const messagesRef = ref(db, `messages/private/${chatId}`);
  const container = document.getElementById('privateMessages');
  container.innerHTML = '';
  
  onChildAdded(messagesRef, (snapshot) => {
    const message = snapshot.val();
    if (message) {
      addMessageToContainer(message, container, 'private');
    }
  });
}

function addMessageToContainer(message, container, type) {
  const messageDiv = document.createElement('div');
  const isSent = message.senderId === currentUser.id;
  
  messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
  
  const time = new Date(message.timestamp).toLocaleTimeString([], { 
    hour: '2-digit', 
    minute: '2-digit' 
  });
  
  if (!isSent && type === 'general') {
    const senderName = onlineUsers[message.senderId]?.name || 'Аноним';
    messageDiv.innerHTML = `
      <div class="message-sender">${senderName}</div>
      <div>${message.text}</div>
      <div class="message-time">${time}</div>
    `;
  } else {
    messageDiv.innerHTML = `
      <div>${message.text}</div>
      <div class="message-time">${time}</div>
    `;
  }
  
  container.appendChild(messageDiv);
  container.scrollTop = container.scrollHeight;
}

// Send general message
sendGeneralBtn.addEventListener('click', sendGeneralMessage);
generalInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') sendGeneralMessage();
});

function sendGeneralMessage() {
  const text = generalInput.value.trim();
  if (!text || !currentUser.id) return;
  
  const messagesRef = ref(db, 'messages/general');
  push(messagesRef, {
    senderId: currentUser.id,
    text: text,
    timestamp: Date.now()
  });
  
  generalInput.value = '';
  updateUserActivity();
}

// Send private message
sendPrivateBtn.addEventListener('click', sendPrivateMessage);
privateInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') sendPrivateMessage();
});

function sendPrivateMessage() {
  const text = privateInput.value.trim();
  if (!text || !currentUser.id || !currentChatWith) return;
  
  const chatId = [currentUser.id, currentChatWith].sort().join('_');
  const messagesRef = ref(db, `messages/private/${chatId}`);
  
  push(messagesRef, {
    senderId: currentUser.id,
    text: text,
    timestamp: Date.now()
  });
  
  privateInput.value = '';
  updateUserActivity();
  stopTyping();
}

// Typing indicator
function setupTypingListener() {
  privateInput.addEventListener('input', () => {
    if (privateInput.value.trim() && currentChatWith) {
      startTyping();
    } else {
      stopTyping();
    }
  });
  
  // Listen for other users typing
  const typingRef = ref(db, 'typing');
  onValue(typingRef, (snapshot) => {
    typingUsers = snapshot.val() || {};
    
    // Update typing indicator in private chat
    if (currentChatWith && typingUsers[currentChatWith]) {
      const typingTo = typingUsers[currentChatWith].typingTo;
      if (typingTo === currentUser.id) {
        document.getElementById('privateTypingIndicator').style.display = 'flex';
      } else {
        document.getElementById('privateTypingIndicator').style.display = 'none';
      }
    } else {
      document.getElementById('privateTypingIndicator').style.display = 'none';
    }
    
    // Update users list
    updateTypingInUsersList();
  });
}

function startTyping() {
  if (!currentUser.id || !currentChatWith) return;
  
  const typingRef = ref(db, `typing/${currentUser.id}`);
  set(typingRef, {
    typingTo: currentChatWith,
    timestamp: Date.now()
  });
  
  clearTimeout(userTypingTimeout);
  userTypingTimeout = setTimeout(stopTyping, 3000);
}

function stopTyping() {
  if (!currentUser.id) return;
  
  const typingRef = ref(db, `typing/${currentUser.id}`);
  remove(typingRef);
}

function updateTypingInUsersList() {
  const userItems = document.querySelectorAll('.list-item');
  userItems.forEach(item => {
    const userId = item.dataset.userId;
    const typingIndicator = item.querySelector('.typing-indicator');
    
    if (typingIndicator) {
      if (typingUsers[userId]) {
        typingIndicator.style.display = 'inline-flex';
      } else {
        typingIndicator.style.display = 'none';
      }
    }
  });
}

// User activity and presence
function updateUserActivity() {
  if (!currentUser.id) return;
  
  const userRef = ref(db, `users/${currentUser.id}`);
  set(userRef, {
    name: currentUser.name,
    isOnline: true,
    lastSeen: Date.now(),
    avatarColor: getRandomColor()
  });
}

function setupPresence() {
  // Update every 30 seconds
  setInterval(() => {
    if (currentUser.id && currentUser.isOnline) {
      updateUserActivity();
    }
  }, 30000);
  
  // Mark as offline when leaving
  window.addEventListener('beforeunload', () => {
    if (currentUser.id) {
      const userRef = ref(db, `users/${currentUser.id}`);
      set(userRef, {
        name: currentUser.name,
        isOnline: false,
        lastSeen: Date.now(),
        avatarColor: getRandomColor()
      });
      
      stopTyping();
    }
  });
}

// Open general chat when clicking general tab
document.querySelector('[data-tab="general"]').addEventListener('click', () => {
  const generalTab = document.querySelector('[data-tab="general"]');
  if (generalTab.classList.contains('active') && !chatContainers.general.classList.contains('active')) {
    containers.online.classList.remove('active');
    containers.chats.classList.remove('active');
    chatContainers.general.classList.add('active');
  }
});
</script>
</body>
</html>
