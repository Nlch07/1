<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>AstikMessenger â€” Mobile + Voice</title>
<style>
  :root{
    --bg:#e9f2fb;
    --card:#ffffff;
    --accent1:#3a7bd5;
    --accent2:#00d2ff;
    --me:#d9f7ff;
    --text:#0b1220;
    --muted:#667085;
  }
  [data-theme="dark"]{
    --bg:#071025; --card:#061226; --me:#07324b; --text:#e6eef7; --muted:#9fb0cc;
  }

  html,body{height:100%;margin:0;font-family:Inter,Roboto,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg),#f7fbff);color:var(--text)}
  /* mobile-first layout */
  .app { max-width:640px; margin:0 auto; height:100vh; display:flex; flex-direction:column; border-radius:12px; overflow:hidden; box-shadow:0 12px 40px rgba(10,20,40,0.12) }
  /* header */
  .header { display:flex;align-items:center;gap:10px;padding:12px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white }
  .logo { width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700 }
  .title { font-size:18px;font-weight:700 }
  .header .actions { margin-left:auto; display:flex; gap:8px; align-items:center }
  .btn { background:transparent;border:none;color:inherit;font-size:18px;padding:8px;border-radius:8px;cursor:pointer }
  /* messages area */
  .messages { flex:1; overflow:auto;padding:12px; background: linear-gradient(180deg, rgba(255,255,255,0.6), transparent) }
  .msg-row { display:flex; margin:8px 0; }
  .msg { max-width:78%; padding:10px 12px; border-radius:12px; background:var(--card); box-shadow:0 6px 15px rgba(10,20,40,0.04); position:relative; }
  .msg.me { margin-left:auto; background:var(--me) }
  .nick { font-weight:700; font-size:13px; margin-bottom:6px }
  .txt { white-space:pre-wrap; word-break:break-word }
  .time { font-size:11px; color:var(--muted); margin-top:6px; text-align:right }
  .small-muted{ font-size:12px; color:var(--muted) }
  .image-thumb { max-width:220px; border-radius:8px; display:block; margin-top:8px }
  audio.msg-audio { width:180px; margin-top:8px; display:block }
  /* compose bar */
  .compose { display:flex; gap:8px; padding:10px; border-top:1px solid rgba(0,0,0,0.06); background:var(--card); align-items:center }
  .compose input[type="text"]{ flex:1; padding:10px 12px; border-radius:999px; border:1px solid #e6eef7; font-size:15px }
  .compose .compose-btn { background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:white;border:none;padding:10px 12px;border-radius:999px;font-size:16px;cursor:pointer }
  .compose .icon-btn { background:transparent;border:none;font-size:20px;padding:8px;cursor:pointer }
  /* recording UI */
  .recorder { display:flex; gap:8px; align-items:center; padding:8px; border-radius:10px; background:rgba(58,123,213,0.06); margin:6px 0 }
  .rec-dot { width:10px;height:10px;border-radius:50%;background:#d9534f;animation:blink 1s linear infinite }
  @keyframes blink { 0%,100%{opacity:1}50%{opacity:0.1} }

  /* responsive: large screens show sidebar */
  @media(min-width:880px){
    .layout { display:grid; grid-template-columns:320px 1fr; height:100% }
    .sidebar { background:var(--card); padding:12px; border-right:1px solid rgba(0,0,0,0.04); overflow:auto }
    .messages { padding:18px }
  }

  /* utility */
  .muted { color:var(--muted) }
  .center { text-align:center }
</style>
</head>
<body>

<div class="app" id="app" data-theme="light">
  <!-- header -->
  <div class="header">
    <div class="logo">A</div>
    <div>
      <div class="title">AstikMessenger</div>
      <div class="small-muted" id="chatSub">ÐžÐ±Ñ‰Ð¸Ð¹ Ñ‡Ð°Ñ‚</div>
    </div>
    <div class="actions">
      <button id="btnTheme" class="btn" title="Ð¢ÐµÐ¼Ð°">ðŸŒ“</button>
      <button id="btnSignIn" class="btn" title="Ð’Ð¾Ð¹Ñ‚Ð¸">Ð’Ð¾Ð¹Ñ‚Ð¸</button>
      <button id="btnSignOut" class="btn" title="Ð’Ñ‹Ð¹Ñ‚Ð¸" style="display:none">â¤«</button>
    </div>
  </div>

  <!-- main content (mobile-first single column) -->
  <div style="flex:1; display:flex; flex-direction:column; min-height:0">
    <div id="messages" class="messages"></div>

    <!-- recorder preview (visible while recording) -->
    <div id="recorderUI" style="display:none;padding:10px">
      <div class="recorder">
        <div class="rec-dot"></div>
        <div id="recTime">00:00</div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="btnCancelRec" class="icon-btn" title="ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ">âœ–</button>
          <button id="btnSendRec" class="compose-btn" title="ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ</button>
        </div>
      </div>
    </div>

    <!-- compose area -->
    <div class="compose">
      <input type="file" id="fileInput" accept="image/*" style="display:none">
      <button id="btnAttach" class="icon-btn" title="Ð˜Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ">ðŸ“·</button>

      <!-- voice button + states -->
      <button id="btnRecord" class="icon-btn" title="Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ">ðŸŽ¤</button>

      <input id="inputMessage" type="text" placeholder="ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..." autocomplete="off" />
      <button id="btnSend" class="compose-btn" title="ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ">âž¤</button>
    </div>
  </div>
</div>

<script type="module">
/* =========================
   Mobile-first + Voice
   Firebase-integrated
   ========================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getDatabase, ref, push, onChildAdded, set, onValue, update } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

/* ---------- YOUR FIREBASE CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCysKcXFVoqWDIQzkdObB-9sgm54cRGyp0",
  authDomain: "test3-88cee.firebaseapp.com",
  databaseURL: "https://test3-88cee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test3-88cee",
  storageBucket: "test3-88cee.firebasestorage.app",
  messagingSenderId: "469479851370",
  appId: "1:469479851370:web:915e95767b012c281e1113"
};
/* ------------------------------------------- */

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const storage = getStorage(app);

/* DOM */
const btnSignIn = document.getElementById("btnSignIn");
const btnSignOut = document.getElementById("btnSignOut");
const btnTheme = document.getElementById("btnTheme");
const messagesEl = document.getElementById("messages");
const btnSend = document.getElementById("btnSend");
const inputMessage = document.getElementById("inputMessage");
const btnAttach = document.getElementById("btnAttach");
const fileInput = document.getElementById("fileInput");
const btnRecord = document.getElementById("btnRecord");
const recorderUI = document.getElementById("recorderUI");
const recTimeEl = document.getElementById("recTime");
const btnCancelRec = document.getElementById("btnCancelRec");
const btnSendRec = document.getElementById("btnSendRec");
const chatSub = document.getElementById("chatSub");

const MESSAGES = "messages";
const TYPING = "typing";

/* state */
let currentUser = null;
let localDeviceId = "dev_" + Math.random().toString(36).slice(2,9);
let mediaRecorder = null;
let recordedChunks = [];
let recStartTs = 0;
let recTimer = null;
let uploadingAudioUrl = null;

/* theme handling */
let theme = localStorage.getItem("astik:theme") || "light";
document.getElementById("app").setAttribute("data-theme", theme);
btnTheme.addEventListener("click", ()=>{
  theme = (theme === "light") ? "dark" : "light";
  document.getElementById("app").setAttribute("data-theme", theme);
  localStorage.setItem("astik:theme", theme);
});

/* auth */
btnSignIn.addEventListener("click", async ()=>{
  const provider = new GoogleAuthProvider();
  try {
    await signInWithPopup(auth, provider);
  } catch(e){ alert("ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ…Ð¾Ð´Ð°: "+e.message) }
});
btnSignOut.addEventListener("click", async ()=> await signOut(auth));

onAuthStateChanged(auth, user => {
  currentUser = user;
  if (user){
    btnSignIn.style.display = "none";
    btnSignOut.style.display = "inline-block";
    chatSub.textContent = `Ð’Ñ‹: ${user.displayName || user.email}`;
    // presence etc could be added
  } else {
    btnSignIn.style.display = "inline-block";
    btnSignOut.style.display = "none";
    chatSub.textContent = "ÐžÐ±Ñ‰Ð¸Ð¹ Ñ‡Ð°Ñ‚";
  }
});

/* messages listening */
function fmtTime(ts){
  const d = new Date(ts || Date.now());
  return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
}

const msgsRef = ref(db, MESSAGES);
onChildAdded(msgsRef, snap => {
  const id = snap.key;
  const msg = snap.val();
  renderMessage(id, msg);
  // if message not from me, mark delivered by me
  if ((currentUser ? currentUser.uid : localDeviceId) !== msg.senderId){
    const delRef = ref(db, `${MESSAGES}/${id}/delivered/${currentUser ? currentUser.uid : localDeviceId}`);
    set(delRef, true);
  }
});

onValue(msgsRef, snap => {
  // optional: can update message statuses when changed
});

/* render */
function renderMessage(id, msg){
  if (!msg) return;
  if (document.getElementById("msg_"+id)) return; // avoid dupes
  const isMe = (msg.senderId === (currentUser ? currentUser.uid : localDeviceId));
  const row = document.createElement("div");
  row.id = "msg_"+id;
  row.className = "msg-row";

  const bubble = document.createElement("div");
  bubble.className = "msg" + (isMe ? " me" : "");
  // header (nick) for others
  if (!isMe){
    const nick = document.createElement("div");
    nick.className = "nick";
    nick.textContent = msg.name || "User";
    bubble.appendChild(nick);
  }

  if (msg.type === "text" || !msg.type){
    const p = document.createElement("div");
    p.className = "txt";
    p.textContent = msg.text || "";
    bubble.appendChild(p);
  } else if (msg.type === "image" && msg.imageUrl){
    const img = document.createElement("img");
    img.className = "image-thumb";
    img.src = msg.imageUrl;
    bubble.appendChild(img);
  } else if (msg.type === "audio" && msg.audioUrl){
    const audio = document.createElement("audio");
    audio.className = "msg-audio";
    audio.controls = true;
    audio.src = msg.audioUrl;
    bubble.appendChild(audio);
  }

  // time / status
  const timeEl = document.createElement("div");
  timeEl.className = "time";
  timeEl.textContent = fmtTime(msg.time);
  bubble.appendChild(timeEl);

  row.appendChild(bubble);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* send text */
btnSend.addEventListener("click", sendTextMessage);
inputMessage.addEventListener("keydown", e=> { if (e.key === "Enter") sendTextMessage(); });

async function sendTextMessage(){
  const text = inputMessage.value.trim();
  if (!text) return;
  const payload = {
    senderId: currentUser ? currentUser.uid : localDeviceId,
    name: currentUser ? (currentUser.displayName || currentUser.email) : "Guest",
    text,
    type: "text",
    time: Date.now()
  };
  await push(ref(db, MESSAGES), payload);
  inputMessage.value = "";
}

/* attach image */
btnAttach.addEventListener("click", ()=> fileInput.click());
fileInput.addEventListener("change", async e=>{
  const f = e.target.files[0];
  if (!f) return;
  try {
    const path = `images/${(currentUser?currentUser.uid:localDeviceId)}/${Date.now()}_${f.name}`;
    const sref1 = sref(storage, path);
    const snap = await uploadBytes(sref1, f);
    const url = await getDownloadURL(sref1);
    await push(ref(db, MESSAGES), {
      senderId: currentUser ? currentUser.uid : localDeviceId,
      name: currentUser ? (currentUser.displayName || currentUser.email) : "Guest",
      type: "image",
      imageUrl: url,
      time: Date.now()
    });
  } catch(err){
    alert("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸: " + err.message);
  } finally {
    fileInput.value = "";
  }
});

/* ===========================
   VOICE MESSAGE: MediaRecorder
   =========================== */
btnRecord.addEventListener("click", async ()=>{
  // start recording if not recording; if recording, stop
  if (!mediaRecorder || mediaRecorder.state === "inactive"){
    startRecording();
  } else {
    stopRecording(); // toggle - stop if already recording
  }
});

async function startRecording(){
  // request mic permission and start MediaRecorder
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    recordedChunks = [];
    mediaRecorder.ondataavailable = e => {
      if (e.data && e.data.size > 0) recordedChunks.push(e.data);
    };
    mediaRecorder.onstop = async () => {
      // blob available
      const blob = new Blob(recordedChunks, { type: 'audio/webm' });
      // upload to firebase storage
      showRecorderUI(false);
      await uploadAudioAndSend(blob);
      // stop tracks
      try { stream.getTracks().forEach(t=>t.stop()); } catch(e){}
    };
    mediaRecorder.start();
    recStartTs = Date.now();
    startRecTimer();
    showRecorderUI(true);
    btnRecord.textContent = "â¹ï¸"; // stop icon
  } catch(err){
    alert("ÐÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ñƒ: " + err.message);
  }
}

function stopRecording(){
  if (mediaRecorder && mediaRecorder.state === "recording"){
    mediaRecorder.stop();
    stopRecTimer();
    btnRecord.textContent = "ðŸŽ¤";
  }
}

function showRecorderUI(on){
  recorderUI.style.display = on ? "block" : "none";
  if (!on){
    recTimeEl.textContent = "00:00";
  }
}

function startRecTimer(){
  recTimer = setInterval(()=>{
    const diff = Math.floor((Date.now() - recStartTs)/1000);
    const mm = String(Math.floor(diff/60)).padStart(2,'0');
    const ss = String(diff%60).padStart(2,'0');
    recTimeEl.textContent = `${mm}:${ss}`;
  }, 250);
}
function stopRecTimer(){ clearInterval(recTimer); recTimer = null; }

/* cancel recording */
btnCancelRec.addEventListener("click", ()=>{
  if (mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
    // we'll not send because recordedChunks will be uploaded in onstop - so clear flag and don't send: set a flag
    recordedChunks = []; // clears recorded data
    showRecorderUI(false);
    btnRecord.textContent = "ðŸŽ¤";
    stopRecTimer();
  }
});

/* upload audio and send message */
async function uploadAudioAndSend(blob){
  try {
    // simple filename + upload
    const filename = `audio/${(currentUser?currentUser.uid:localDeviceId)}/${Date.now()}.webm`;
    const storageRef = sref(storage, filename);
    // show small local "uploading" message (optional)
    const uploadSnap = await uploadBytes(storageRef, blob);
    const url = await getDownloadURL(storageRef);
    // send message with audioUrl
    await push(ref(db, MESSAGES), {
      senderId: currentUser ? currentUser.uid : localDeviceId,
      name: currentUser ? (currentUser.displayName || currentUser.email) : "Guest",
      type: "audio",
      audioUrl: url,
      time: Date.now()
    });
  } catch(err){
    alert("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð°ÑƒÐ´Ð¸Ð¾: " + err.message);
  }
}

/* small UX: allow tapping audio files to play (browser does) */
/* optionally implement progress / waveforms later */

/* final small helpers */
window.addEventListener("beforeunload", ()=>{
  // clear typing state
  set(ref(db, `${TYPING}/${localDeviceId}`), "");
});
</script>
</body>
</html>
