<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Astik Chat</title>
  <meta name="theme-color" content="#00ff9d">
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root { --astik: #00ff9d; --bg: #000; --card: #111; --text: #fff; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system,system-ui,"Segoe UI",Roboto,sans-serif; background:#000; color:#fff; height:100vh; display:flex; flex-direction:column; }
    
    header { background:#008c6e; color:white; padding:16px; text-align:center; font-weight:bold; font-size:19px; border-radius:20px 20px 0 0; position:relative; }
    .edit-nick { position:absolute; right:16px; top:16px; font-size:14px; opacity:0.8; cursor:pointer; }

    #chat-list { flex:1; overflow-y:auto; padding:10px; }
    .chat-item { display:flex; align-items:center; padding:14px; background:var(--card); margin-bottom:10px; border-radius:16px; cursor:pointer; }
    .avatar { width:56px; height:56px; border-radius:50%; background:var(--astik); color:#000; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:22px; margin-right:14px; flex-shrink:0; }
    .info { flex:1; }
    .chat-name { font-weight:600; font-size:17px; }
    .last-msg { font-size:14px; color:#aaa; margin-top:4px; }

    #chat-screen { display:none; flex-direction:column; height:100%; background:#000; }
    #chat-header { background:#008c6e; padding:16px; display:flex; align-items:center; border-radius:20px 20px 0 0; }
    .back-btn { background:none; border:none; color:white; font-size:26px; cursor:pointer; margin-right:12px; }
    #chat-messages { flex:1; overflow-y:auto; padding:16px; }
    .message { max-width:78%; margin:8px 0; padding:11px 16px; border-radius:18px; word-wrap:break-word; }
    .me { background:var(--astik); color:#000; align-self:flex-end; margin-left:auto; border-bottom-right-radius:4px; }
    .other { background:#222; align-self:flex-start; border-bottom-left-radius:4px; }
    .time { font-size:11px; color:#888; margin-top:5px; text-align:right; }

    .input-bar { padding:12px; background:#111; display:flex; gap:10px; align-items:center; }
    #msg-input { flex:1; padding:14px 18px; background:#222; color:white; border:none; border-radius:30px; font-size:16px; }
    #send-btn { background:var(--astik); color:#000; border:none; width:50px; height:50px; border-radius:50%; cursor:pointer; font-size:20px; font-weight:bold; }

    .new-chat-btn { position:fixed; bottom:25px; right:25px; background:var(--astik); color:#000; width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:32px; cursor:pointer; box-shadow:0 4px 20px rgba(0,255,157,0.4); z-index:100; }
  </style>
</head>
<body>

  <!-- Список чатов -->
  <div id="main">
    <header>
      Мои чаты
      <span class="edit-nick" onclick="changeNick()">Edit</span>
    </header>
    <div id="chat-list">
      <div class="chat-item" onclick="openPublic()">
        <div class="avatar">G</div>
        <div class="info">
          <div class="chat-name">Общий чат</div>
          <div class="last-msg">Все пишут сюда</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Экран чата -->
  <div id="chat-screen">
    <div id="chat-header">
      <button class="back-btn" onclick="back()">Back</button>
      <div class="avatar" id="partner-avatar">A</div>
      <div class="info">
        <div class="chat-name" id="partner-name">Чат</div>
      </div>
    </div>
    <div id="chat-messages"></div>
    <div class="input-bar">
      <input type="text" id="msg-input" placeholder="Сообщение...">
      <button id="send-btn" onclick="send()">Send</button>
    </div>
  </div>

  <!-- Кнопка + -->
  <div class="new-chat-btn" onclick="newChat()">+</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCysKcXFVoqWDIQzkdObB-9sgm54cRGyp0",
  authDomain: "test3-88cee.firebaseapp.com",
  databaseURL: "https://test3-88cee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test3-88cee",
  storageBucket: "test3-88cee.appspot.com",
  messagingSenderId: "469479851370",
  appId: "1:469479851370:web:915e95767b012c281e1113"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let myName = localStorage.getItem('astik_nick') || '';
if (!myName) {
  myName = prompt("Твой ник:", "Гость" + Math.floor(Math.random()*9999)).trim() || "Гость";
  localStorage.setItem('astik_nick', myName);
}

let currentPartner = null;

// ID чата = сортировка ников
function chatId(a, b) {
  return [a.toLowerCase(), b.toLowerCase()].sort().join('_');
}

// Смена ника
function changeNick() {
  const n = prompt("Новый ник:", myName);
  if (n && n.trim() && n.trim() !== myName) {
    myName = n.trim();
    localStorage.setItem('astik_nick', myName);
    loadChats();
  }
}

// Новый чат — просто вводим ник
function newChat() {
  const nick = prompt("С кем начать чат?\nВведи ник:", "").trim();
  if (!nick || nick === myName) return alert("Неправильный ник");
  openPrivate(nick);
}

// Открыть личный чат
function openPrivate(partner) {
  currentPartner = partner;
  document.getElementById('main').style.display = 'none';
  document.getElementById('chat-screen').style.display = 'flex';
  document.getElementById('partner-name').textContent = partner;
  document.getElementById('partner-avatar').textContent = partner[0].toUpperCase();
  document.getElementById('chat-messages').innerHTML = '';

  const id = chatId(myName, partner);
  db.ref(`chats/${id}/messages`).limitToLast(100).on('child_added', s => {
    const m = s.val();
    addMessage(m.text, m.from === myName);
  });
}

// Общий чат
function openPublic() {
  currentPartner = null;
  document.getElementById('main').style.display = 'none';
  document.getElementById('chat-screen').style.display = 'flex';
  document.getElementById('partner-name').textContent = "Общий чат";
  document.getElementById('partner-avatar').textContent = "G";
  document.getElementById('chat-messages').innerHTML = '';

  db.ref('public_chat').limitToLast(100).on('child_added', s => {
    const m = s.val();
    addMessage(m.text, m.name === myName, m.name);
  });
}

function addMessage(text, isMe, senderName = null) {
  const div = document.createElement('div');
  div.className = `message ${isMe ? 'me' : 'other'}`;
  const name = isMe ? '' : `<small style="color:#00ff9d;">${senderName}</small><br>`;
  div.innerHTML = `${name}${text}`;
  document.getElementById('chat-messages').appendChild(div);
  div.scrollIntoView({behavior:'smooth'});
}

function send() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text) return;

  if (currentPartner) {
    // Личный чат
    const id = chatId(myName, currentPartner);
    db.ref(`chats/${id}/messages`).push({
      from: myName,
      text: text,
      time: Date.now()
    });
  } else {
    // Общий чат
    db.ref('public_chat').push({
      name: myName,
      text: text,
      time: Date.now()
    });
  }
  input.value = '';
}

function back() {
  document.getElementById('chat-screen').style.display = 'none';
  document.getElementById('main').style.display = 'flex';
  loadChats();
}

// Загрузка списка чатов
function loadChats() {
  db.ref('chats').on('value', snap => {
    const list = document.getElementById('chat-list');
    list.innerHTML = `<div class="chat-item" onclick="openPublic()">
      <div class="avatar">G</div>
      <div class="info">
        <div class="chat-name">Общий чат</div>
        <div class="last-msg">Все пишут сюда</div>
      </div>
    </div>`;

    snap.forEach(child => {
      const chat = child.val();
      const id = child.key;
      if (chat.messages) {
        const users = id.split('_');
        const partner = users.find(u => u !== myName.toLowerCase());
        if (partner) {
          const lastMsg = Object.values(chat.messages).pop();
          const div = document.createElement('div');
          div.className = 'chat-item';
          div.onclick = () => openPrivate(partner.charAt(0).toUpperCase() + partner.slice(1));
          div.innerHTML = `
            <div class="avatar">${partner[0].toUpperCase()}</div>
            <div class="info">
              <div class="chat-name">${partner.charAt(0).toUpperCase() + partner.slice(1)}</div>
              <div class="last-msg">${lastMsg?.text || 'Начните чат'}</div>
            </div>
          `;
          list.appendChild(div);
        }
      }
    });
  });
}

// Старт
loadChats();

// Enter = отправить
document.getElementById('msg-input')?.addEventListener('keypress', e => {
  if (e.key === 'Enter') send();
});
</script>
</body>
</html>
