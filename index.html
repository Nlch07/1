<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Astik Chat</title>
  <meta name="theme-color" content="#007bff">
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --primary: #007bff;
      --bg: #ffffff;
      --card: #f8f9fa;
      --text: #212529;
      --input-bg: #ffffff;
      --msg-me: #007bff;
      --msg-other: #e9ecef;
      --border: #dee2e6;
    }
    [data-theme="dark"] {
      --primary: #0d6efd;
      --bg: #121212;
      --card: #1e1e1e;
      --text: #e0e0e0;
      --input-bg: #2d2d2d;
      --msg-me: #0d6efd;
      --msg-other: #333;
      --border: #333;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; transition:0.3s; }
    header { background:var(--primary); color:white; padding:16px; text-align:center; font-weight:bold; font-size:20px; position:relative; }
    .change-name { position:absolute; right:16px; top:16px; font-size:14px; opacity:0.8; cursor:pointer; }
    #main, #chat-screen { height:100%; display:flex; flex-direction:column; }
    #chat-list { flex:1; overflow-y:auto; padding:10px; }
    .chat-item { display:flex; align-items:center; padding:14px; background:var(--card); margin-bottom:8px; border-radius:12px; cursor:pointer; border:1px solid var(--border); }
    .avatar { width:50px; height:50px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:20px; margin-right:12px; }
    .chat-name { font-weight:600; font-size:17px; }
    .last-msg { font-size:14px; color:#666; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    #chat-header { background:var(--primary); color:white; padding:16px; display:flex; align-items:center; position:relative; }
    .back { background:none; border:none; color:white; font-size:24px; cursor:pointer; }
    #chat-messages { flex:1; overflow-y:auto; padding:16px; background:var(--bg); }
    .message { max-width:75%; margin:8px 0; padding:10px 14px; border-radius:18px; position:relative; word-wrap:break-word; }
    .me { background:var(--msg-me); color:white; align-self:flex-end; margin-left:auto; border-bottom-right-radius:4px; }
    .other { background:var(--msg-other); align-self:flex-start; border-bottom-left-radius:4px; }
    .time { font-size:11px; opacity:0.7; margin-top:4px; text-align:right; }
    .input-bar { padding:10px; background:var(--card); border-top:1px solid var(--border); display:flex; gap:10px; }
    #msg-input { flex:1; padding:14px 16px; border-radius:50px; border:1px solid var(--border); background:var(--input-bg); font-size:16px; }
    #send-btn { background:var(--primary); color:white; border:none; width:50px; height:50px; border-radius:50%; cursor:pointer; font-size:20px; }
    .theme-toggle { position:fixed; bottom:20px; right:20px; background:var(--primary); color:white; width:56px; height:56px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px; cursor:pointer; box-shadow:0 4px 20px rgba(0,123,255,0.3); z-index:100; }
    #main { display:none; }
  </style>
</head>
<body>

  <!-- Список чатов -->
  <div id="main">
    <header>
      Astik Chat
      <span class="change-name" onclick="changeName()">Сменить ник</span>
    </header>
    <div id="chat-list">
      <div class="chat-item" onclick="openChat('public', 'Общий чат', 'G')">
        <div class="avatar">G</div>
        <div class="info">
          <div class="chat-name">Общий чат</div>
          <div class="last-msg">Нажми чтобы войти</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Экран чата -->
  <div id="chat-screen" style="display:none">
    <div id="chat-header">
      <button class="back" onclick="backToList()">Back</button>
      <div class="avatar" id="chat-avatar">A</div>
      <div class="info"><div id="chat-title">Чат</div></div>
    </div>
    <div id="chat-messages"></div>
    <div class="input-bar">
      <input type="text" id="msg-input" placeholder="Сообщение...">
      <button id="send-btn" onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- Переключатель темы -->
  <div class="theme-toggle" onclick="toggleTheme()">
    <i class="fas fa-moon" id="theme-icon"></i>
  </div>

<script>
// === ТВОЙ FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyCysKcXFVoqWDIQzkdObB-9sgm54cRGyp0",
  authDomain: "test3-88cee.firebaseapp.com",
  databaseURL: "https://test3-88cee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test3-88cee",
  storageBucket: "test3-88cee.appspot.com",
  messagingSenderId: "469479851370",
  appId: "1:469479851370:web:915e95767b012c281e1113"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let myName = localStorage.getItem('astik_nick') || '';
if (!myName) {
  myName = prompt("Введи свой ник:", "Гость" + Math.floor(Math.random()*9999)).trim();
  localStorage.setItem('astik_nick', myName);
}

// Запрос разрешений на уведомления
if (Notification.permission === "default") Notification.requestPermission();

// Тема
const savedTheme = localStorage.getItem('theme') || 'light';
if (savedTheme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');

function toggleTheme() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
  localStorage.setItem('theme', isDark ? 'light' : 'dark');
  document.getElementById('theme-icon').classList.toggle('fa-sun');
  document.getElementById('theme-icon').classList.toggle('fa-moon');
}

// Смена ника
function changeName() {
  const newName = prompt("Новый ник:", myName);
  if (newName && newName.trim()) {
    myName = newName.trim();
    localStorage.setItem('astik_nick', myName);
    loadChats();
  }
}

// Генерация ID чата
function getChatId(a, b) {
  return [a.toLowerCase(), b.toLowerCase()].sort().join('_');
}

let currentChatId = null;

// Открыть чат
function openChat(id, title, avatarLetter) {
  currentChatId = id;
  document.getElementById('main').style.display = 'none';
  document.getElementById('chat-screen').style.display = 'flex';
  document.getElementById('chat-title').textContent = title;
  document.getElementById('chat-avatar').textContent = avatarLetter;
  document.getElementById('chat-messages').innerHTML = '';

  const path = id === 'public' ? 'public_chat/messages' : `private_chats/${id}/messages`;
  db.ref(path).limitToLast(50).on('child_added', snap => {
    const msg = snap.val();
    addMessage(msg.text || msg.message, msg.name || msg.from, msg.time || Date.now());
  });
}

// Добавить сообщение
function addMessage(text, sender, time) {
  const div = document.createElement('div');
  div.className = `message ${sender === myName ? 'me' : 'other'}`;
  div.innerHTML = `${text}<div class="time">${new Date(time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>`;
  document.getElementById('chat-messages').appendChild(div);
  div.scrollIntoView({behavior:'smooth'});

  // Уведомление
  if (sender !== myName && document.hidden) {
    new Notification("Новое сообщение", {
      body: `${sender}: ${text.substring(0,50)}${text.length>50?'...':''}`,
      icon: "https://i.ibb.co.com/7zX7Y3K/astikk.png"
    });
  }
}

function sendMessage() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text || !currentChatId) return;

  const msgData = { name: myName, text: text, time: Date.now() };
  const path = currentChatId === 'public' ? 'public_chat/messages' : `private_chats/${currentChatId}/messages`;
  db.ref(path).push(msgData);

  if (currentChatId !== 'public') {
    db.ref(`private_chats/${currentChatId}`).update({ lastMessage: text, timestamp: Date.now() });
  }
  input.value = '';
}

function backToList() {
  document.getElementById('chat-screen').style.display = 'none';
  document.getElementById('main').style.display = 'flex';
  loadChats();
}

// Создать личку
function createPrivate() {
  const nick = prompt("Ник собеседника:");
  if (!nick || nick === myName) return alert("Некорректный ник");
  const chatId = getChatId(myName, nick);
  db.ref(`private_chats/${chatId}`).set({
    users: [myName, nick],
    lastMessage: "Чат создан",
    timestamp: Date.now()
  });
  loadChats();
}

// Загрузка чатов
function loadChats() {
  document.getElementById('chat-list').innerHTML = `
    <div class="chat-item" onclick="openChat('public','Общий чат','G')">
      <div class="avatar">G</div>
      <div class="info"><div class="chat-name">Общий чат</div><div class="last-msg">Нажми чтобы войти</div></div>
    </div>
    <div class="chat-item" onclick="createPrivate()" style="justify-content:center; background:var(--primary); color:white;">
      <i class="fas fa-plus" style="font-size:24px;"></i> Новая переписка
    </div>
  `;

  db.ref('private_chats').orderByChild('timestamp').on('value', snap => {
    const container = document.getElementById('chat-list');
    const existing = container.querySelectorAll('.private-chat');
    existing.forEach(el => el.remove());

    snap.forEach(child => {
      const chat = child.val();
      const id = child.key;
      if (chat.users && chat.users.includes(myName)) {
        const partner = chat.users.find(u => u !== myName);
        const div = document.createElement('div');
        div.className = 'chat-item private-chat';
        div.onclick = () => openChat(id, partner, partner[0].toUpperCase());
        div.innerHTML = `
          <div class="avatar">${partner[0].toUpperCase()}</div>
          <div class="info">
            <div class="chat-name">${partner}</div>
            <div class="last-msg">${chat.lastMessage || 'Чат создан'}</div>
          </div>
        `;
        container.appendChild(div);
      }
    });
  });
}

// Старт
document.getElementById('main').style.display = 'flex';
loadChats();

// Enter = отправить
document.getElementById('msg-input').addEventListener('keypress', e => {
  if (e.key === 'Enter') sendMessage();
});
</script>
</body>
</html>
