<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Мой Чат</title>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#000;color:#fff;font-family:system-ui,sans-serif;height:100vh;display:flex;flex-direction:column}
    .screen{display:none;flex-direction:column;height:100%}
    .active{display:flex!important}
    #menu{justify-content:center;align-items:center;gap:30px;padding:20px}
    .btn{width:90%;max-width:400px;padding:24px;font-size:21px;font-weight:bold;border-radius:20px;border:none;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    #btn-name{background:#ff2d55}
    #btn-public{background:#00d4ff}
    #btn-create{background:#7c4dff}
    header{padding:16px;background:#111;text-align:center;font-size:19px;position:relative}
    .back{position:absolute;top:10px;left:10px;background:none;border:none;color:#fff;font-size:30px;cursor:pointer}
    #messages{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:12px}
    .msg{max-width:80%;padding:12px 16px;border-radius:20px;line-height:1.4;word-wrap:break-word}
    .my{align-self:flex-end;background:#0d8bff;border-bottom-right-radius:4px}
    .other{align-self:flex-start;background:#333;border-bottom-left-radius:4px}
    .name{font-size:13px;opacity:0.8;margin-bottom:4px}
    #input-area{padding:12px;background:#111;display:flex;gap:12px}
    #message{flex:1;padding:16px 20px;background:#222;color:#fff;border:none;border-radius:30px;font-size:17px}
    #send{width:56px;height:56px;background:#0d8bff;border:none;border-radius:50%;font-size:26px}
    .link-box{background:#222;padding:20px;margin:20px;border-radius:16px;text-align:center}
    .link-box a{color:#7c4dff;font-size:18px;font-weight:bold;word-break:break-all}
    .copy-btn{background:#7c4dff;padding:14px 24px;border:none;border-radius:12px;margin-top:15px;font-size:16px}
  </style>
</head>
<body>

  <!-- Главное меню -->
  <div id="menu" class="screen active">
    <h1 style="font-size:30px;margin-bottom:50px">Мой Чат</h1>
    <button id="btn-name" class="btn">Указать имя</button>
    <button id="btn-public" class="btn">Общий чат</button>
    <button id="btn-create" class="btn">Создать личный чат</button>
  </div>

  <!-- Установка имени -->
  <div id="setname" class="screen">
    <h2 style="padding:30px 20px;text-align:center">Как тебя зовут?</h2>
    <div style="padding:20px">
      <input type="text" id="nameInput" placeholder="Твоё имя" maxlength="20" style="width:100%;padding:18px;font-size:18px;border-radius:16px;background:#222;border:none;color:white;text-align:center">
      <button onclick="saveName()" style="margin-top:20px;width:100%;padding:18px;background:#ff2d55;border:none;border-radius:16px;color:white;font-size:18px">Сохранить</button>
    </div>
  </div>

  <!-- Создание личного чата — показываем ссылку -->
  <div id="create" class="screen">
    <header>Личный чат создан!<button class="back" onclick="goMenu()">Back</button></header>
    <div style="flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:20px">
      <p style="text-align:center;margin-bottom:20px">Отправь эту ссылку человеку, с кем хочешь писать вдвоём:</p>
      <div class="link-box">
        <div id="generated-link"></div>
        <button class="copy-btn" onclick="copyLink()">Скопировать ссылку</button>
      </div>
      <button onclick="enterGeneratedChat()" style="margin-top:30px;padding:16px 32px;background:#7c4dff;border:none;border-radius:16px;font-size:18px">
        Войти в этот чат
      </button>
    </div>
  </div>

  <!-- Общий чат -->
  <div id="public" class="screen">
    <header>Общий чат <button class="back" onclick="goMenu()">Back</button></header>
    <div id="messages"></div>
    <div id="input-area">
      <input type="text" id="msg-public" placeholder="Сообщение..." maxlength="500">
      <button id="send">Send</button>
    </div>
  </div>

  <!-- Личный чат (по ссылке) -->
  <div id="private" class="screen">
    <header>Личный чат <button class="back" onclick="goMenu()">Back</button></header>
    <div id="messages-private"></div>
    <div id="input-area">
      <input type="text" id="msg-private" placeholder="Сообщение..." maxlength="500">
      <button id="send-private">Send</button>
    </div>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCysKcXFVoqWDIQzkdObB-9sgm54cRGyp0",
  authDomain: "test3-88cee.firebaseapp.com",
  databaseURL: "https://test3-88cee-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test3-88cee",
  storageBucket: "test3-88cee.firebasestorage.app",
  messagingSenderId: "469479851370",
  appId: "1:469479851370:web:915e95767b012c281e1113"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let myName = localStorage.getItem('myName') || 'Аноним';
let currentPrivateCode = '';

// Установка имени
document.getElementById('btn-name').onclick = () => showScreen('setname');
function saveName() {
  myName = document.getElementById('nameInput').value.trim() || 'Аноним';
  localStorage.setItem('myName', myName);
  goMenu();
}

// Общий чат
document.getElementById('btn-public').onclick = () => {
  showScreen('public');
  loadChat('public_messages', 'messages', 'msg-public');
};

// Создать личный чат → генерируем код и ссылку
document.getElementById('btn-create').onclick = () => {
  const words = ['love','secret','cat','sun','moon','star','heart','fire','ice','dream','kiss','hug','baby','angel','devil','magic','night','rose','sky','ocean'];
  const n1 = words[Math.floor(Math.random()*words.length)];
  const n2 = words[Math.floor(Math.random()*words.length)];
  const num = Math.floor(Math.random()*99);
  currentPrivateCode = n1 + n2 + num; // например: lovekiss42

  const link = location.origin + location.pathname + '?c=' + currentPrivateCode;
  document.getElementById('generated-link').textContent = link;
  showScreen('create');
};

function copyLink() {
  navigator.clipboard.writeText(document.getElementById('generated-link').textContent);
  alert('Ссылка скопирована!');
}

function enterGeneratedChat() {
  openPrivateChat(currentPrivateCode);
}

// Открытие личного чата по параметру ?c=
const urlParams = new URLSearchParams(location.search);
const codeFromUrl = urlParams.get('c');
if (codeFromUrl) {
  currentPrivateCode = codeFromUrl;
  openPrivateChat(codeFromUrl);
}

function openPrivateChat(code) {
  showScreen('private');
  loadChat('private_chats/' + code + '/messages', 'messages-private', 'msg-private');
}

// Универсальные функции
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function goMenu() { showScreen('menu'); history.replaceState(null,null,' '); }

function loadChat(path, containerId, inputId) {
  const ref = db.ref(path);
  // Очищаем старые сообщения
  document.getElementById(containerId).innerHTML = '';
  ref.orderByChild('time').limitToLast(100).on('child_added', snap => {
    const msg = snap.val();
    const div = document.createElement('div');
    div.className = 'msg ' + (msg.name===myName ? 'my' : 'other');
    div.innerHTML = `<div class="name">${msg.name===myName?'Вы':msg.name}</div><div>${msg.text}</div>`;
    document.getElementById(containerId).appendChild(div);
    document.getElementById(containerId).scrollTop = document.getElementById(containerId).scrollHeight;
  });

  // Отправка
  const sendBtn = containerId==='messages' ? 'send' : 'send-private';
  document.getElementById(sendBtn).onclick = () => {
    const text = document.getElementById(inputId).value.trim();
    if(text){
      ref.push({name:myName, text:text, time:Date.now()});
      document.getElementById(inputId).value='';
    }
  };
  document.getElementById(inputId).addEventListener('keypress', e=> {if(e.key==='Enter') document.getElementById(sendBtn).click();});
}
</script>
</body>
</html>
